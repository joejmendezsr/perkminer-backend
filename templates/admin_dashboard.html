<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - PerkMiner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
      th, td { word-break: break-word; }
      .table-responsive { min-height: 0.01%; }
      @media (max-width: 768px) {
        .nav-tabs .nav-link { font-size: 0.98em; padding: 0.4em 0.7em; }
        .btn, .btn-sm, .btn-warning, .btn-danger, .btn-secondary { font-size: 0.98em !important; }
      }
      /* Always wrap tables for mobile usability */
      .table-responsive { overflow-x: auto; }
    </style>
</head>
<body>
<a href="{{ url_for('admin_roles_landing') }}" class="btn btn-warning mb-3 w-100 w-md-auto">
  <i class="bi bi-shield-lock-fill"></i> Go to Admin Roles Area
</a>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger mt-4 w-100 w-md-auto">Logout</a>
<div class="container py-4">
    <h2 class="mb-4 text-center text-md-start">Admin Dashboard</h2>

    <!-- Navigation tabs -->
    <ul class="nav nav-tabs mb-3 flex-wrap" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="businesses-tab" data-bs-toggle="tab" data-bs-target="#businesses" type="button" role="tab">Businesses</button>
      </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">

      <!-- Users Tab -->
      <div class="tab-pane fade show active" id="users" role="tabpanel">
        <form class="row gy-2 mb-3" method="get" action="{{ url_for('admin_dashboard') }}">
          <div class="col-12 col-md-4">
            <input type="text" name="user_search" class="form-control" placeholder="Search users..." value="{{ request.args.get('user_search', '') }}">
          </div>
          <div class="col-12 col-md-3">
            <select name="user_role" class="form-select">
              <option value="">All Roles</option>
              {% for role in roles %}
              <option value="{{ role.name }}" {% if request.args.get('user_role', '') == role.name %}selected{% endif %}>{{ role.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-3">
            <select name="user_status" class="form-select">
              <option value="">All Statuses</option>
              <option value="confirmed" {% if request.args.get('user_status') == 'confirmed' %}selected{% endif %}>Confirmed Email</option>
              <option value="pending" {% if request.args.get('user_status') == 'pending' %}selected{% endif %}>Pending Email</option>
              <option value="suspended" {% if request.args.get('user_status') == 'suspended' %}selected{% endif %}>Suspended</option>
            </select>
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" class="btn btn-primary w-100">Search</button>
          </div>
        </form>
        <h4 class="mt-3">Registered Users</h4>
        <button class="btn btn-secondary mb-2 d-none d-md-inline-block" onclick="window.print()">Print Users Table</button>
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Name/Email</th>
                <th>Email Verified</th>
                <th>Referral Code</th>
                <th>Roles</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>{{ user.id }}</td>
                <td>
                  {{ user.name or '' }}<br>
                  <small>{{ user.email }}</small>
                </td>
                <td>
                  {% if user.email_confirmed %}
                    <span class="badge bg-success">Yes</span>
                  {% else %}
                    <span class="badge bg-secondary">No</span>
                  {% endif %}
                </td>
                <td>{{ user.referral_code }}</td>
                <td>
                  {% for role in user.roles %}
                    <span class="badge bg-info text-dark">{{ role.name }}</span>
                  {% endfor %}
                </td>
                <td>
                  <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" class="btn btn-sm btn-warning mb-1">Edit</a>
                  <form method="post" action="{{ url_for('admin_delete_user', user_id=user.id) }}" style="display:inline;" onsubmit="return confirm('Delete this user?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-sm btn-danger mb-1">Delete</button>
                  </form>
                  <form method="post" action="{{ url_for('admin_suspend_user', user_id=user.id) }}" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if user.is_suspended %}
                      <button type="submit" class="btn btn-sm btn-success mb-1" title="Unsuspend">Unsuspend</button>
                    {% else %}
                      <button type="submit" class="btn btn-sm btn-secondary mb-1" title="Suspend">Suspend</button>
                    {% endif %}
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

<!-- Businesses Tab -->
<div class="tab-pane fade" id="businesses" role="tabpanel">
  <form class="row gy-2 mb-3" method="get" action="{{ url_for('admin_dashboard') }}">
    <div class="col-12 col-md-4">
      <input type="text" name="biz_search" class="form-control" placeholder="Search businesses..." value="{{ request.args.get('biz_search', '') }}">
    </div>
    <div class="col-12 col-md-3">
      <select name="biz_category" class="form-select">
        <option value="">All Categories</option>
        <option value="Handyman-Contractor" {% if request.args.get('biz_category') == 'Handyman-Contractor' %}selected{% endif %}>Handyman-Contractor</option>
        <option value="Auto Parts & Service" {% if request.args.get('biz_category') == 'Auto Parts & Service' %}selected{% endif %}>Auto Parts & Service</option>
        <option value="Home and Garden" {% if request.args.get('biz_category') == 'Home and Garden' %}selected{% endif %}>Home and Garden</option>
        <option value="Retail Outlet" {% if request.args.get('biz_category') == 'Retail Outlet' %}selected{% endif %}>Retail Outlet</option>
        <option value="Professional Services" {% if request.args.get('biz_category') == 'Professional Services' %}selected{% endif %}>Professional Services</option>
        <option value="Restaurant" {% if request.args.get('biz_category') == 'Restaurant' %}selected{% endif %}>Restaurant</option>
        <option value="Real Estate" {% if request.args.get('biz_category') == 'Real Estate' %}selected{% endif %}>Real Estate</option>
        <option value="Other" {% if request.args.get('biz_category') == 'Other' %}selected{% endif %}>Other</option>
      </select>
    </div>
    <div class="col-12 col-md-3">
      <select name="biz_status" class="form-select">
        <option value="">All Statuses</option>
        <option value="approved" {% if request.args.get('biz_status') == 'approved' %}selected{% endif %}>Approved</option>
        <option value="pending" {% if request.args.get('biz_status') == 'pending' %}selected{% endif %}>Pending</option>
        <option value="not_submitted" {% if request.args.get('biz_status') == 'not_submitted' %}selected{% endif %}>Not Submitted</option>
        <option value="rejected" {% if request.args.get('biz_status') == 'rejected' %}selected{% endif %}>Rejected</option>
      </select>
    </div>
    <div class="col-12 col-md-2">
      <button type="submit" class="btn btn-primary w-100">Search</button>
    </div>
  </form>
  <h4 class="mt-3">Registered Businesses</h4>
  <button class="btn btn-secondary mb-2 d-none d-md-inline-block" onclick="window.print()">Print Businesses Table</button>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Name/Email</th>
          <th>Email Verified</th>
          <th>Category</th>
          <th>Referral Code</th>
          <th>Approved by</th>
          <th>Actions</th>
        </tr>
      </thead>
<tbody>
  {% for biz in businesses %}
  <tr>
    <td>{{ biz.id }}</td>
    <td>
      {{ biz.business_name or '' }}<br>
      <small>{{ biz.business_email }}</small>
    </td>
    <td>
      {% if biz.email_confirmed %}
        <span class="badge bg-success">Yes</span>
      {% else %}
        <span class="badge bg-secondary">No</span>
      {% endif %}
    </td>
    <td>{{ biz.category }}</td>
    <td>{{ biz.referral_code }}</td>
    <td>
      {% set approver = user_lookup.get(biz.approved_by) %}
      {{ approver.email if approver else (biz.approved_by or '') }}
    </td>
    <td>
      <a href="{{ url_for('admin_edit_business', business_id=biz.id) }}" class="btn btn-sm btn-warning mb-1">Edit</a>
      <form method="post" action="{{ url_for('admin_delete_business', business_id=biz.id) }}" style="display:inline;" onsubmit="return confirm('Delete this business?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {{ business_forms[biz.id].hidden_tag() }}
        <button type="submit" class="btn btn-sm btn-danger mb-1">Delete</button>
      </form>
      <form method="post" action="{{ url_for('admin_suspend_business', business_id=biz.id) }}" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {{ business_forms[biz.id].hidden_tag() }}
        {% if biz.is_suspended %}
          <button type="submit" class="btn btn-sm btn-success mb-1" title="Unsuspend">Unsuspend</button>
        {% else %}
          <button type="submit" class="btn btn-sm btn-secondary mb-1" title="Suspend">Suspend</button>
        {% endif %}
      </form>
      <button class="btn btn-sm btn-success disabled mb-1">Approve Listing</button>
      <button class="btn btn-sm btn-success disabled mb-1">Reject Listing</button>
    </td>
  </tr>
  {% endfor %}
</tbody>
    </table>
  </div>
</div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>