<!DOCTYPE html>
<html>
<head>
    <title>Business Earnings - PerkMiner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
      @media (max-width: 600px) { .table, .btn { font-size: .98em;} }
      .summary-card { background:#f7fafb; border-radius:13px; box-shadow:0 1px 6px #e1e9ed; padding:18px 12px 9px 12px; margin:16px 0 28px 0;}
    </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
    <h3 class="mb-2">Business Earnings</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('export_business_receipts_csv') }}?month={{month}}&year={{year}}" class="btn btn-outline-success">
        <i class="bi bi-cloud-arrow-down"></i> Export CSV/Excel
      </a>
      <button onclick="window.print()" class="btn btn-outline-secondary">
        <i class="bi bi-printer"></i> Print / Save as PDF
      </button>
    </div>
  </div>
  <form class="row gy-2 gx-2 mb-3" id="filter-form" method="get">
    <div class="col-sm-3">
      <h4>Select Month-Year</h4>
      <input type="month" name="year_month" id="year_month" class="form-control"
        value="{% if year and month %}{{ '%04d-%02d' % (year, month) }}{% else %}{{ today.strftime('%Y-%m') }}{% endif %}">
    </div>
    <div class="col-sm-3">
      <input type="number" step="0.01" id="amount" name="amount" class="form-control" placeholder="Min Amount">
    </div>
    <div class="col-sm-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Search receipts...">
    </div>
    <div class="col-sm-2">
      <button class="btn btn-primary w-100" type="submit">Search</button>
    </div>
  </form>
  <div class="summary-card">
    <b>Gross Earnings:</b> ${{ summary.gross_earnings }}<br>
    <b>Advertising Fee (10%):</b> ${{ summary.ad_fee }}<br>
    <b>Net Gross Earnings:</b> ${{ summary.net_gross }}<br>
    <b>Marketing ROI:</b> {{ summary.marketing_roi }}%<br>
    <b>Marketing ROI Ratio:</b> {{ summary.marketing_ratio }}:1<br>
    <hr>
    <b>Tier 1 (Self):</b> ${{ summary.tier1_earnings }}<br>
    <b>Tier 2:</b> ${{ summary.tier2_earnings }}<br>
    <b>Tier 3:</b> ${{ summary.tier3_earnings }}<br>
    <b>Tier 4:</b> ${{ summary.tier4_earnings }}<br>
    <b>Tier 5:</b> ${{ summary.tier5_earnings }}<br>
    <hr>
    <b>Total Cash Back (All Tiers):</b> ${{ summary.total_cash_back }}
  </div>
  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="receipts-table">
      <thead class="table-light">
        <tr>
          <th>Date/Time</th>
          <th>Gross Amount</th>
          <th>Ad Fee (10%)</th>
          <th>Net Gross</th>
          <th>ROI</th>
          <th>ROI Ratio</th>
          <th>Cashback (1%)</th>
          <th>Tier 2</th>
          <th>Tier 3</th>
          <th>Tier 4</th>
          <th>Tier 5</th>
        </tr>
      </thead>
      <tbody>
        {% for txn in transactions %}
        <tr>
          <td>{{ txn.date_time.strftime('%Y-%m-%d %I:%M %p') }}</td>
          <td>${{ "{:,.2f}".format(txn.amount) }}</td>
          <td>
            {% set ad_fee = txn.amount * 0.10 %}
            ${{ "{:,.2f}".format(ad_fee) }}
          </td>
          <td>
            {% set net_gross = txn.amount - ad_fee %}
            ${{ "{:,.2f}".format(net_gross) }}
          </td>
          <td>
            {% set roi = (net_gross/ad_fee)*100 if ad_fee else 0 %}
            {{ roi | round(0) }}%
          </td>
          <td>
            {% set ratio = (net_gross+ad_fee)/ad_fee if ad_fee else 0 %}
            {{ ratio|round(2) }}:1
          </td>
          <td>${{ "{:,.2f}".format(txn.cash_back) }}</td>
          <td>${{ "{:,.2f}".format(txn.tier2_commission) }}</td>
          <td>${{ "{:,.2f}".format(txn.tier3_commission) }}</td>
          <td>${{ "{:,.2f}".format(txn.tier4_commission) }}</td>
          <td>${{ "{:,.2f}".format(txn.tier5_commission) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <a href="{{ url_for('business_dashboard') }}" class="btn btn-primary mt-3 w-100">Back to Dashboard</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById('filter-form').addEventListener('input', function() {
    const minDateObj = document.getElementById('year_month').value;
    const amount = parseFloat(document.getElementById('amount').value) || 0;
    const filter = document.getElementById('searchInput').value.toLowerCase();

    document.querySelectorAll('#receipts-table tbody tr').forEach(function(row) {
        const cells = row.querySelectorAll('td');
        const rowDate = cells[0].textContent;
        const rowAmount = parseFloat(cells[1].textContent.replace(/[^0-9.-]+/g,"")) || 0;
        const rowText = row.textContent.toLowerCase();

        let show = true;

        // filter by month
        if (minDateObj) {
            const year = minDateObj.split('-')[0];
            const month = minDateObj.split('-')[1];
            const firstOfMonth = new Date(`${year}-${month}-01`);
            const lastOfMonth = new Date(firstOfMonth.getFullYear(), firstOfMonth.getMonth() + 1, 0);
            const rowTime = new Date(rowDate);
            if (rowTime < firstOfMonth || rowTime > lastOfMonth) show = false;
        }
        if (amount && rowAmount < amount) show = false;
        if (filter && rowText.indexOf(filter) === -1) show = false;

        row.style.display = show ? "" : "none";
    });
});
</script>
</body>
</html>