<!DOCTYPE html>
<html>
<head>
    <title>Active Session</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
      #messages-box {
        max-height: 45vh;
        min-height: 200px;
        overflow-y: auto;
        background: #f9f9fa;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #e5e5ea;
        word-wrap: break-word;
      }
      .msg-bubble-user, .msg-bubble-biz {
        display: inline-block;
        padding: 9px 15px;
        line-break: anywhere;
        margin-bottom: 2px;
        min-width: 80px;
        max-width: 88vw;
        font-size: 1rem;
        word-break: break-word;
      }
      .msg-bubble-user {
        background: #e2eafc;
        border-radius: 14px 12px 2px 14px;
      }
      .msg-bubble-biz {
        background: #eafbe2;
        border-radius: 14px 14px 14px 2px;
      }
      .msg-time { font-size: .82em; color: #aaa; margin-left: 4px;}
      .file-clip { color: #888; font-size:1.05em; margin-right: 1px;}
      .chat-img-thumb {
        max-height: 120px;
        max-width: 180px;
        margin-top: 7px;
        display: block;
        border-radius: 7px;
        border: 1.5px solid #ddd;
      }
      @media (max-width: 768px) {
        .msg-bubble-user, .msg-bubble-biz { max-width: 98vw; }
        .chat-img-thumb { max-width: 98vw; }
      }
    </style>
</head>
<body>
<div class="container py-3">
    <div class="card p-3">
        <div class="mb-2">
            {% if is_user %}
                <h5>Active Session with {{ interaction.business.business_name }}</h5>
            {% elif is_biz %}
                <h5>Active Session with {{ interaction.user.name or interaction.user.email }}</h5>
            {% endif %}
        </div>
        {% if is_user and not interaction.awaiting_finalization %}
          <div class="mb-3 text-center">
            <form method="post" action="{{ url_for('active_session', interaction_id=interaction.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="accept_and_pay" value="1">
              <button type="submit" class="btn btn-success w-100">Accept & Pay (Show My QR Code)</button>
            </form>
          </div>
        {% elif is_user and interaction.awaiting_finalization %}
          <div class="mb-3 text-center">
            <p class="mb-2 text-success fw-bold">Show this QR code to the business to complete payment:</p>
            <img src="{{ url_for('user_qr_code') }}" alt="Your QR Code" style="max-width:160px; margin-top:10px;">
            <div id="user-receipt-wait" class="alert alert-info mt-3 mb-0">
                Waiting for business to finalize payment...<br><span class="spinner-border spinner-border-sm text-warning"></span>
            </div>
          </div>
        {% endif %}

        {% if is_biz and interaction.awaiting_finalization %}
          <div class="mb-3 text-center">
            <a href="{{ url_for('scan_qr', interaction_id=interaction.id) }}" class="btn btn-warning w-100">Scan QR to Finalize Payment</a>
          </div>
        {% endif %}

        {% if is_biz %}
          <a href="{{ url_for('create_quote', interaction_id=interaction.id) }}" class="btn btn-warning mb-2 w-100">Send Quote</a>
        {% endif %}

        {% if is_user and interaction.quote %}
          <div class="alert alert-info text-center">
            <a href="{{ url_for('view_quote', interaction_id=interaction.id) }}" class="btn btn-warning">
              View Quote &#128176;
            </a>
          </div>
        {% endif %}

        <div id="messages-box">
          {% for msg in messages %}
            <div class="row {% if msg.sender_type == 'user' and is_user or msg.sender_type == 'business' and is_biz %}justify-content-end{% else %}justify-content-start{% endif %} mb-2">
              <div class="col-auto">
                <div class="{% if msg.sender_type == 'user' %}msg-bubble-user{% else %}msg-bubble-biz{% endif %}">
                  <span class="fw-bold small {% if msg.sender_type == 'user' %}text-primary{% else %}text-success{% endif %}">
                    {% if msg.sender_type == "user" %}
                      {{ interaction.user.name or interaction.user.email }}
                    {% elif msg.sender_type == "business" %}
                      {{ interaction.business.business_name }}
                    {% endif %}
                  </span>
                  <span class="msg-time">{{ msg.timestamp.strftime('%Y-%m-%d %I:%M%p') }}</span>
                  <div>{{ msg.text | e }}</div>
                  {% if msg.file_url and msg.file_name and msg.file_name.lower().endswith(('.png','.jpg','.jpeg','.gif','.webp')) %}
                    <a href="{{ msg.file_url }}" target="_blank">
                      <img src="{{ msg.file_url }}" alt="{{ msg.file_name }}" class="chat-img-thumb">
                    </a>
                  {% elif msg.file_url %}
                    <div class="mt-1">
                      <a href="{{ msg.file_url }}" target="_blank">
                        <span class="file-clip">&#128206;</span>{{ msg.file_name or "Download Attachment" }}
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% else %}
            <div class="text-center text-muted fst-italic mt-2">No messages yet. Start the conversation!</div>
          {% endfor %}
        </div>

        <form method="post" enctype="multipart/form-data" autocomplete="off" id="chat-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="input-group flex-wrap">
            <input type="text" name="message_text" id="message_text" class="form-control mb-2 mb-md-0" placeholder="Type a message..." maxlength="500" style="min-width:140px" autocomplete="off" autofocus>
            <input type="file" name="message_file" class="form-control mb-2 mb-md-0" style="max-width:170px" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt">
            <button class="btn btn-primary" type="submit">Send</button>
          </div>
          <small class="form-text text-muted d-block mt-1">Supports emoji ðŸ˜Š images, .pdf, .doc, .xls, .txt. Max size: 5MB.</small>
        </form>

        <div class="mt-3 d-flex flex-wrap gap-2">
            <form method="post" action="{{ url_for('end_session', interaction_id=interaction.id) }}" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-danger flex-grow-1" type="submit">End Session</button>
            </form>
        </div>
        {% if is_user %}
            <a href="{{ url_for('user_biz_interactions') }}" class="btn btn-secondary mt-3 w-100">Back</a>
        {% elif is_biz %}
            <a href="{{ url_for('biz_user_interactions') }}" class="btn btn-secondary mt-3 w-100">Back</a>
        {% endif %}
    </div>
</div>
<script>
  function scrollToBottom() {
      var box = document.getElementById('messages-box');
      if (box) { box.scrollTop = box.scrollHeight; }
  }
  scrollToBottom();

  document.getElementById('chat-form').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      this.submit();
    }
  });

  function reloadMessages() {
      fetch("{{ url_for('session_messages', interaction_id=interaction.id) }}")
        .then(res => res.text())
        .then(html => {
            document.getElementById('messages-box').innerHTML = html;
            scrollToBottom();
        });
  }
  setInterval(reloadMessages, 4000);

  // When user is waiting on finalize, poll for a receipt
  {% if is_user and interaction.awaiting_finalization %}
  function checkForReceipt() {
    fetch("{{ url_for('check_user_receipt', interaction_id=interaction.id) }}")
      .then(resp => resp.json())
      .then(data => {
        if (data.has_receipt) {
          window.location.href = "{{ url_for('show_user_receipt', interaction_id=interaction.id) }}";
        } else {
          setTimeout(checkForReceipt, 4000);
        }
      });
  }
  checkForReceipt();
  {% endif %}
</script>
</body>
</html>