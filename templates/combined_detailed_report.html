<!DOCTYPE html>
<html>
<head>
  <title>Combined Detailed Report - Finance Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Combined Detailed Report</h3>
    <a href="{{ url_for('finance_dashboard') }}" class="btn btn-outline-primary">Return to Finance Dashboard</a>
    <a href="{{ url_for('export_combined_detailed_report_csv', interaction_id=interaction_id, user_email=user_email, business_email=business_email, period=period, year=year, month=month) }}" class="btn btn-outline-success mb-2">
      <i class="bi bi-cloud-arrow-down"></i> Export CSV/Excel
    </a>
  </div>
  <form class="row gy-2 gx-2 mb-3" method="get">
    <div class="col-12 col-md-2">
      <input type="text" name="interaction_id" class="form-control" placeholder="Interaction ID" value="{{ interaction_id or '' }}">
    </div>
    <div class="col-12 col-md-2">
      <input type="text" name="user_email" class="form-control" placeholder="User Email" value="{{ user_email or '' }}">
    </div>
    <div class="col-12 col-md-2">
      <input type="text" name="business_email" class="form-control" placeholder="Business Email" value="{{ business_email or '' }}">
    </div>
    <div class="col-12 col-md-2">
      <select class="form-select" name="period">
        <option value="all" {% if period == 'all' %}selected{% endif %}>All</option>
        <option value="year" {% if period == 'year' %}selected{% endif %}>Year</option>
        <option value="month" {% if period == 'month' %}selected{% endif %}>Month</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <select class="form-select" name="month">
        <option value="">Any Month</option>
        {% for val, name in months %}
          <option value="{{ val }}" {% if month == val %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <select class="form-select" name="year">
        <option value="">Any Year</option>
        {% for y in years %}
          <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 mt-1">
      <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Search</button>
    </div>
  </form>
  <div class="mb-4">
    <b>Grand Total (Business Transactions):</b> ${{ "{:,.2f}".format(grand_total) }}<br>
    <b>Total Advertising Fee:</b> ${{ "{:,.2f}".format(total_ad_fee) }}<br>
    <b>Total Paid to Users: Cashback (Tier 1):</b> ${{ "{:,.2f}".format(total_user_cash_back) }}<br>
    <b>Total Paid to Users: Commissions (Tiers 2-5):</b> ${{ "{:,.2f}".format(total_user_commission) }}<br>
    <b>Total Paid to Users: User-Business Commission (Tiers 1-5):</b> ${{ "{:,.2f}".format(total_user_business_commission) }}<br>
    <b>Total Paid to Businesses (Tiers 1-5):</b> ${{ "{:,.2f}".format(total_biz_cash_back) }}<br>
    <b>Grand Total Paid Out:</b> ${{ "{:,.2f}".format(total_paid_all) }}
  </div>
  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="details-table">
      <thead>
        <tr>
          <th>Date/Time</th>
          <th>Interaction ID</th>
          <th>User Referral ID</th>
          <th>User Name</th>
          <th>User Email</th>
          <th>Tier 1 Cashback</th>
          <th>Tier 2 Commission</th>
          <th>Tier 3 Commission</th>
          <th>Tier 4 Commission</th>
          <th>Tier 5 Commission</th>
          <th>Tier 1 User-Biz</th>
          <th>Tier 2 User-Biz</th>
          <th>Tier 3 User-Biz</th>
          <th>Tier 4 User-Biz</th>
          <th>Tier 5 User-Biz</th>
          <th>Business Referral ID</th>
          <th>Business Name</th>
          <th>Business Email</th>
          <th>Tier 1 Biz Cashback</th>
          <th>Tier 2 Biz Cashback</th>
          <th>Tier 3 Biz Cashback</th>
          <th>Tier 4 Biz Cashback</th>
          <th>Tier 5 Biz Cashback</th>
          <th>Transaction ID</th>
        </tr>
      </thead>
      <tbody>
        {% for t in utrans %}
        <tr>
          <td>{{ t.date_time.strftime('%Y-%m-%d %I:%M %p') }}</td>
          <td>{{ t.interaction_id }}</td>
          <td>{{ t.user_referral_id }}</td>
          <td>{{ user_lookup[t.user_referral_id].name if t.user_referral_id in user_lookup else "" }}</td>
          <td>{{ user_lookup[t.user_referral_id].email if t.user_referral_id in user_lookup else "" }}</td>
          <td>${{ "{:,.2f}".format(t.cash_back) }}</td>
          <td>${{ "{:,.2f}".format(t.tier2_commission) }}</td>
          <td>${{ "{:,.2f}".format(t.tier3_commission) }}</td>
          <td>${{ "{:,.2f}".format(t.tier4_commission) }}</td>
          <td>${{ "{:,.2f}".format(t.tier5_commission) }}</td>
          <td>${{ "{:,.2f}".format(t.tier1_business_user_commission or 0) }}</td>
          <td>${{ "{:,.2f}".format(t.tier2_business_user_commission or 0) }}</td>
          <td>${{ "{:,.2f}".format(t.tier3_business_user_commission or 0) }}</td>
          <td>${{ "{:,.2f}".format(t.tier4_business_user_commission or 0) }}</td>
          <td>${{ "{:,.2f}".format(t.tier5_business_user_commission or 0) }}</td>
          <td></td><td></td><td></td>
          <td></td><td></td><td></td><td></td><td></td>
          <td>{{ t.transaction_id }}</td>
        </tr>
        {% endfor %}
        {% for t in btrans %}
        <tr>
          <td>{{ t.date_time.strftime('%Y-%m-%d %I:%M %p') }}</td>
          <td>{{ t.interaction_id }}</td>
          <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          <td></td><td></td><td></td><td></td><td></td>
          <td>{{ t.business_referral_id }}</td>
          <td>{{ business_lookup[t.business_referral_id].business_name if t.business_referral_id in business_lookup else '' }}</td>
          <td>{{ business_lookup[t.business_referral_id].business_email if t.business_referral_id in business_lookup else '' }}</td>
          <td>${{ "{:,.2f}".format(t.cash_back) }}</td>
          <td>${{ "{:,.2f}".format(t.tier2_commission) }}</td>
          <td>${{ "{:,.2f}".format(t.tier3_commission) }}</td>
          <td>${{ "{:,.2f}".format(t.tier4_commission) }}</td>
          <td>${{ "{:,.2f}".format(t.tier5_commission) }}</td>
          <td>{{ t.transaction_id }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>