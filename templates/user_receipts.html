<!DOCTYPE html>
<html>
<head>
    <title>My Receipts - PerkMiner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
      @media (max-width: 600px) {
        .card, .table { font-size: 0.98em; }
        .btn { width: 100%; margin-bottom: 10px; }
      }
      .print-btn { float: right; }
    </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
    <h3 class="mb-2">My Receipts</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('export_user_receipts_csv') }}" class="btn btn-outline-success">
        <i class="bi bi-cloud-arrow-down"></i> Export CSV/Excel
      </a>
      <button onclick="window.print()" class="btn btn-outline-secondary">
        <i class="bi bi-printer"></i> Print / Save as PDF
      </button>
    </div>
  </div>
  <!-- Filter Controls -->
  <form class="row gy-2 gx-2 mb-3" id="filter-form" onsubmit="return false;">
    <div class="col-sm-3">
      <input type="date" id="min-date" class="form-control" placeholder="Start Date">
    </div>
    <div class="col-sm-3">
      <input type="date" id="max-date" class="form-control" placeholder="End Date">
    </div>
    <div class="col-sm-2">
      <input type="number" step="0.01" id="amount" class="form-control" placeholder="Min Amount">
    </div>
    <div class="col-sm-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Search receipts...">
    </div>
  </form>
  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="receipts-table">
      <thead class="table-light">
        <tr>
          <th>Date/Time</th>
          <th>Business</th>
          <th>Amount</th>
          <th>Cashback (2%)</th>
          <th>Receipt</th>
        </tr>
      </thead>
      <tbody>
        {% for txn in transactions %}
        <tr>
          <td>{{ txn.date_time.strftime('%Y-%m-%d %I:%M %p') }}</td>
          <td>
            {% set interaction = txn.interaction %}
            {{ interaction.business.business_name if interaction else 'N/A' }}
          </td>
          <td>${{ "{:,.2f}".format(txn.amount) }}</td>
          <td>${{ "{:,.2f}".format(txn.cash_back) }}</td>
          <td>
            <a href="{{ url_for('show_user_receipt', interaction_id=txn.interaction_id) }}" class="btn btn-info btn-sm">View</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <a href="{{ url_for('dashboard') }}" class="btn btn-primary mt-3 w-100">Back to Dashboard</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById('filter-form').addEventListener('input', function() {
    const minDate = document.getElementById('min-date').value;
    const maxDate = document.getElementById('max-date').value;
    const amount = parseFloat(document.getElementById('amount').value) || 0;
    const filter = document.getElementById('searchInput').value.toLowerCase();

    document.querySelectorAll('#receipts-table tbody tr').forEach(function(row) {
        const cells = row.querySelectorAll('td');
        const rowDate = cells[0].textContent;
        const rowAmount = parseFloat(cells[2].textContent.replace(/[^0-9.-]+/g,"")) || 0;
        const rowText = row.textContent.toLowerCase();

        let show = true;
        if (minDate && new Date(rowDate) < new Date(minDate)) show = false;
        if (maxDate && new Date(rowDate) > new Date(maxDate + ' 23:59:59')) show = false;
        if (amount && rowAmount < amount) show = false;
        if (filter && rowText.indexOf(filter) === -1) show = false;

        row.style.display = show ? "" : "none";
    });
});
</script>
</body>
</html>