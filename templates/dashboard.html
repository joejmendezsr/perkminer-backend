<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
      .pointer { cursor: pointer; }
    </style>
    <script>
      function calculateNetworkEarnings() {
        let numPeople = parseInt(document.getElementById('network_people').value, 10) || 0;
        let amount = parseFloat(document.getElementById('network_amount').value) || 0;
        if (amount > 2500) amount = 2500;
        document.getElementById('network_amount').value = amount;
        let t1 = 0.02 * amount;
        let t2 = 0.0025 * amount * numPeople;
        let t3 = 0.0025 * amount * Math.pow(numPeople, 2);
        let t4 = 0.0025 * amount * Math.pow(numPeople, 3);
        let t5 = 0.02 * amount * Math.pow(numPeople, 4);
        let total = t1 + t2 + t3 + t4 + t5;
        document.getElementById('network_t1').innerText = t1.toFixed(2);
        document.getElementById('network_t2').innerText = t2.toFixed(2);
        document.getElementById('network_t3').innerText = t3.toFixed(2);
        document.getElementById('network_t4').innerText = t4.toFixed(2);
        document.getElementById('network_t5').innerText = t5.toFixed(2);
        document.getElementById('network_total').innerText = total.toFixed(2);
        document.getElementById('network_results').style.display = 'block';
      }
      // Frontend calculator for single reward
      function calculateSingleReward() {
        let amount = parseFloat(document.getElementById('reward_amount').value) || 0;
        if (amount > 2500) amount = 2500;
        document.getElementById('reward_amount').value = amount;
        let tier = document.getElementById('reward_tier').value;
        let reward = 0;
        let desc = "";
        let cap = null;
        if (tier === "1") {
            reward = amount * 0.02; desc = "As the customer, you earn";
        } else if (["2","3","4"].includes(tier)) {
            reward = amount * 0.0025;
            cap = 6.25;
            if (reward > cap) reward = cap;
            desc = `If your level ${tier} downline makes a purchase`;
        } else if (tier === "5") {
            reward = amount * 0.02;
            cap = 50;
            if (reward > cap) reward = cap;
            desc = "If your level 5 downline makes a purchase";
        }
        let out = '';
        if (amount > 0) {
          out += `<h5 class='mt-4 mb-2'>${desc} of $${amount.toFixed(2)}:</h5>`;
          out += `<div class='alert alert-success'>You earn <strong>$${reward.toFixed(2)}</strong> as cashback${cap?` (capped at $${cap.toFixed(2)}).`:"."}</div>`;
        }
        document.getElementById('rewards_output').innerHTML = out;
      }
    </script>
</head>
<body>
    <div class="container py-5">

      <!-- Collapsible Welcome & Profile Bar -->
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
          <div class="d-flex align-items-center">
            {% if profile_img_url %}
              <img src="{{ profile_img_url }}" alt="Profile Photo" class="rounded-circle me-3" style="width:70px;height:70px;object-fit:cover;">
            {% else %}
              <div style="width:70px;height:70px;background:#eee;" class="rounded-circle d-flex justify-content-center align-items-center me-3">No Image</div>
            {% endif %}
            <h2 class="mb-0">
                Welcome, {{ user_name if user_name else email }}!
            </h2>
          </div>
          <a class="fw-semibold text-primary pointer ms-2" data-bs-toggle="collapse" href="#profileCollapse" aria-expanded="false" aria-controls="profileCollapse">
            View/Edit Profile
          </a>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-danger ms-md-3 mt-3 mt-md-0">Logout</a>
      </div>

      <!-- Profile Edit Section (collapsible)-->
      <div class="collapse mb-4" id="profileCollapse">
        <div class="card p-4">
          <h4>Your Profile</h4>
          <form method="post" enctype="multipart/form-data" class="row g-3 align-items-center">
              {{ profile_form.hidden_tag() }}
              <div class="col-12 col-md-auto mb-3 mb-md-0 text-center">
                  {% if profile_img_url %}
                    <img src="{{ profile_img_url }}" alt="Profile Photo" class="rounded-circle" style="width:100px;height:100px;object-fit:cover;">
                  {% else %}
                    <div style="width:100px;height:100px;display:inline-block;background:#eee;" class="rounded-circle text-center d-flex justify-content-center align-items-center">No Image</div>
                  {% endif %}
                  <input type="file" name="profile_photo" accept="image/*" class="form-control mt-2">
              </div>
              <div class="col-12 col-md-auto mb-3 mb-md-0">
                  <label class="form-label">Name</label>
                  {{ profile_form.name(class="form-control", value=user_name, placeholder="Enter your name") }}
              </div>
              <div class="col-12 col-md-auto">
                  {{ profile_form.submit(class="btn btn-success") }}
              </div>
          </form>
        </div>
      </div>
      <!-- End Profile Edit Section -->

      <div class="card p-4 mb-4">
          <h4>Your Referral Code:</h4>
          <code>{{ referral_code }}</code>
      </div>
      {% if sponsor %}
      <div class="card p-4 mb-4">
          <h4>Your Sponsor:</h4>
          <p class="mb-0">{{ sponsor }}</p>
      </div>
      {% endif %}
      <div class="card p-4 mb-4">
          <h4>Estimate Your Rewards From One Single Purchase</h4>
          <div class="row g-3 mb-3">
              <div class="col-12 col-md-auto">
                  <input id="reward_amount" type="number" class="form-control" placeholder="Amount (e.g. 500)" max="2500" required>
              </div>
              <div class="col-12 col-md-auto">
                  <select id="reward_tier" class="form-select" required>
                      <option value="1" selected>Tier 1 (your purchases)</option>
                      <option value="2">Tier 2 (direct referral purchases)</option>
                      <option value="3">Tier 3 (Tier 2 referral purchases)</option>
                      <option value="4">Tier 4 (Tier 3 referral purchases)</option>
                      <option value="5">Tier 5 (Tier 4 referral purchases)</option>
                  </select>
              </div>
              <div class="col-12 col-md-auto">
                  <button type="button" class="btn btn-primary" onclick="calculateSingleReward()">Calculate My Reward</button>
              </div>
          </div>
          <div id="rewards_output">
            {{ rewards_table | safe }}
          </div>
      </div>
      <div class="card p-4 mb-4">
        <h4>Referral Network Cashback Calculator (one purchase from everyone in your network during the month)</h4>
        <div class="mb-2">
          <label>If you and everyone in your network refers 
            <input id="network_people" type="number" class="form-control d-inline-block w-auto" min="1" value="2" style="width:80px;" />
            people and you each make one purchase during the month in the amount of $ 
            <input id="network_amount" type="number" class="form-control d-inline-block w-auto" min="0" max="2500" step="0.01" value="100" style="width:110px;" />
            , this is how much you would earn in Cashback Rewards for the month:
          </label>
          <small class="text-muted d-block">*Maximum purchase amount allowed is $2,500</small>
        </div>
        <button class="btn btn-info mb-2" type="button" onclick="calculateNetworkEarnings()">Calculate</button>
        <div id="network_results" style="display:none;">
          <ul class="mb-1">
            <li>Tier One: (Your purchases) = <span id="network_t1"></span></li>
            <li>Tier Two: (Purchases from your direct referrals) = <span id="network_t2"></span></li>
            <li>Tier Three: (Purchases from 2nd Tier referrals) = <span id="network_t3"></span></li>
            <li>Tier Four: (Purchases from 3rd Tier referrals) = <span id="network_t4"></span></li>
            <li>Tier Five: (Purchases from 4th Tier referrals) = <span id="network_t5"></span></li>
          </ul>
          <strong>Your total cashback earnings for the month would be $<span id="network_total"></span></strong>
        </div>
      </div>
      <div class="card p-4 mb-4">
          <h4>My Network</h4>
          <div>
              <a role="button" class="fw-semibold text-primary" data-bs-toggle="collapse" href="#tier2" aria-expanded="false" aria-controls="tier2">
                  Tier 2 (direct referrals)
              </a>
              <div class="collapse mt-2" id="tier2">
                  {% if level2 %}
                      <ul class="mb-2">{% for user in level2 %}<li>{{ user.email }} ({{ user.referral_code }})</li>{% endfor %}</ul>
                  {% else %}
                      <span>None</span>
                  {% endif %}
              </div>
          </div>
          <div>
              <a role="button" class="fw-semibold text-primary" data-bs-toggle="collapse" href="#tier3" aria-expanded="false" aria-controls="tier3">
                  Tier 3 (referred by Tier 2 people)
              </a>
              <div class="collapse mt-2" id="tier3">
                  {% if level3 %}
                      <ul class="mb-2">{% for user in level3 %}<li>{{ user.email }} ({{ user.referral_code }})</li>{% endfor %}</ul>
                  {% else %}
                      <span>None</span>
                  {% endif %}
              </div>
          </div>
          <div>
              <a role="button" class="fw-semibold text-primary" data-bs-toggle="collapse" href="#tier4" aria-expanded="false" aria-controls="tier4">
                  Tier 4 (referred by Tier 3 people)
              </a>
              <div class="collapse mt-2" id="tier4">
                  {% if level4 %}
                      <ul class="mb-2">{% for user in level4 %}<li>{{ user.email }} ({{ user.referral_code }})</li>{% endfor %}</ul>
                  {% else %}
                      <span>None</span>
                  {% endif %}
              </div>
          </div>
          <div>
              <a role="button" class="fw-semibold text-primary" data-bs-toggle="collapse" href="#tier5" aria-expanded="false" aria-controls="tier5">
                  Tier 5 (referred by Tier 4 people)
              </a>
              <div class="collapse mt-2" id="tier5">
                  {% if level5 %}
                      <ul class="mb-2">{% for user in level5 %}<li>{{ user.email }} ({{ user.referral_code }})</li>{% endfor %}</ul>
                  {% else %}
                      <span>None</span>
                  {% endif %}
              </div>
          </div>
      </div>
      <div class="card p-4">
          <h4>This is your dashboard.</h4>
          <p class="mb-0">Congrats on building a secure, styled Python web app!</p>
      </div>
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-warning mt-3">
            {% for message in messages %}
              {{ message }}<br>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>