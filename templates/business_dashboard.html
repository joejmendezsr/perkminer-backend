<!DOCTYPE html>
<html>
<head>
    <title>Business Dashboard - PerkMiner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        :root {
          --pm-primary: #2a5859;
          --pm-accent: #ffd66b;
          --pm-bg: #fff;
          --pm-text: #222;
          --pm-hover: #e6f6f5;
          --pm-focus: #fadd92;
        }
        body {
          background: var(--pm-bg);
          color: var(--pm-text);
        }
        body > nav {
          margin-bottom: 2rem !important;
        }
        .navbar {
          box-shadow: 0 2px 8px #f0f2f3;
        }
        .card, .dashboard-section {
          background: #f8fafb;
          border-radius: 16px;
          box-shadow: 0 2px 16px #e3eee9;
          margin-bottom: 1.5rem;
          transition: box-shadow 0.2s;
        }
        .card:hover, .dashboard-section:hover {
          box-shadow: 0 6px 24px #d2eced;
        }
        .profile-pic {
          width: 84px;
          height: 84px;
          object-fit: cover;
          border-radius: 50%;
          background: var(--pm-hover);
          border: 2px solid var(--pm-primary);
        }
        .placeholder-pic {
          width: 84px; height: 84px; border-radius: 50%;
          background: #e6f6f5;
          color: var(--pm-primary);
          display: flex; align-items: center; justify-content: center;
          font-size: 2.4em;
          border: 2px solid var(--pm-primary);
        }
        .btn-primary, .btn-success {
          background: var(--pm-primary);
          border: none;
          color: #fff !important;
        }
        .btn-primary:hover, .btn-success:hover {
          background: var(--pm-accent);
          color: var(--pm-text) !important;
        }
        .btn-outline-danger {
          border-color: #bf3636;
          color: #bf3636 !important;
        }
        .btn-outline-danger:hover {
          background: #bf3636;
          color: #fff !important;
        }
        a:focus, button:focus, input:focus {
          outline: 2px solid var(--pm-focus);
          outline-offset: 2px;
        }
        .input-group, .form-control, .form-select {
          border-radius: 10px !important;
        }
        label { font-weight: 500; }
        .pointer { cursor: pointer; }
        @media (max-width: 600px) {
          .card, .dashboard-section {
            padding: 1rem;
          }
          .profile-pic, .placeholder-pic {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
          }
        }
        footer {
          background: #f8fafb;
          color: #999;
          padding: 1.5rem 0;
          margin-top: 3rem;
          text-align: center;
          font-size: 1em;
          border-top: 1px solid #e1e7ea;
        }
    </style>
    <script>
      function calculateNetworkEarnings() {
        let numPeople = parseInt(document.getElementById('network_people').value, 10) || 0;
        let amount = parseFloat(document.getElementById('network_amount').value) || 0;
        if (amount > 2500) amount = 2500;
        document.getElementById('network_amount').value = amount;
        let t1 = 0.01 * amount;
        let t2 = 0.0025 * amount * numPeople;
        let t3 = 0.0025 * amount * Math.pow(numPeople, 2);
        let t4 = 0.0025 * amount * Math.pow(numPeople, 3);
        let t5 = 0.01 * amount * Math.pow(numPeople, 4);
        let total = t1 + t2 + t3 + t4 + t5;
        document.getElementById('network_t1').innerText = t1.toFixed(2);
        document.getElementById('network_t2').innerText = t2.toFixed(2);
        document.getElementById('network_t3').innerText = t3.toFixed(2);
        document.getElementById('network_t4').innerText = t4.toFixed(2);
        document.getElementById('network_t5').innerText = t5.toFixed(2);
        document.getElementById('network_total').innerText = total.toFixed(2);
        document.getElementById('network_results').style.display = 'block';
      }
      function calculateSingleReward() {
        let amount = parseFloat(document.getElementById('reward_amount').value) || 0;
        if (amount > 2500) amount = 2500;
        document.getElementById('reward_amount').value = amount;
        let tier = document.getElementById('reward_tier').value;
        let reward = 0;
        let desc = "";
        let cap = null;
        if (tier === "1") {
            reward = amount * 0.01; desc = "As the business, from a paid invoice you generate";
        } else if (["2","3","4"].includes(tier)) {
            reward = amount * 0.0025;
            cap = 6.25;
            if (reward > cap) reward = cap;
            desc = `If your Tier ${tier} referral generates a paid invoice`;
        } else if (tier === "5") {
            reward = amount * 0.01;
            cap = 50;
            if (reward > cap) reward = cap;
            desc = "If your Tier 5 generates a paid invoice";
        }
        let out = '';
        if (amount > 0) {
          out += `<h5 class='mt-4 mb-2'>${desc} of $${amount.toFixed(2)}:</h5>`;
          out += `<div class='alert alert-success'>You earn <strong>$${reward.toFixed(2)}</strong> as cashback${cap?` (capped at $${cap.toFixed(2)}).`:"."}</div>`;
        }
        document.getElementById('rewards_output').innerHTML = out;
      }
    </script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">PerkMiner</a>
        <div class="navbar-nav ms-auto">
          <span class="nav-link disabled">{{ email }}</span>
        </div>
    </div>
</nav>
<div class="container py-4">
  <div class="card mb-4 p-4">
    <div class="d-flex align-items-center flex-wrap mb-3">
      {% if profile_img_url %}
        <img src="{{ profile_img_url }}" alt="Profile Photo" class="profile-pic me-3">
      {% else %}
        <div class="placeholder-pic me-3"><i class="bi bi-person"></i></div>
      {% endif %}
      <div>
        <h2 class="mb-0">
          Welcome, {{ biz.business_name if biz.business_name else (user_name if user_name else email) }}!
        </h2>
      </div>
      <div class="ms-auto d-flex gap-2 flex-wrap">
        <a href="{{ url_for('business_logout') }}" class="btn btn-outline-danger">Logout</a>
      </div>
    </div>

    <!-- Profile Section -->
    <div class="card p-4 mb-4">
      <div class="mb-3 d-flex gap-2 flex-wrap">
        <button class="btn btn-secondary" type="button" id="previewListingBtn">
          Preview Listing
        </button>
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
          data-bs-target="#profileCollapse" aria-expanded="false" aria-controls="profileCollapse">
          View/Edit Profile
        </button>
      </div>
      <!-- Account Balance and Fund/Add Funds Button -->
      <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap">
        <div class="fw-bold" style="font-size:1.15em;">
          Account Balance: <span class="text-success">
            ${{ "{:,.2f}".format(biz.account_balance or 0.0) }}
          </span>
        </div>
        <a href="{{ url_for('fund_account') }}" class="btn btn-warning ms-2 flex-shrink-0">
          <i class="bi bi-wallet2 me-1"></i>Add Funds
        </a>
      </div>
      {% if has_active_biz_sessions %}
        <div class="mb-2">
          <a href="{{ url_for('biz_user_interactions') }}" class="btn btn-outline-primary w-100">
            <i class="bi bi-chat-dots me-1"></i>My Active Sessions
          </a>
        </div>
      {% endif %}
      {% if payment_alerts %}
        <div class="mb-3">
          <div class="alert alert-warning text-center p-2 mb-2">
            <b>New Scan:</b> A customer is awaiting for you to scan their QR code!
            {% for ia in payment_alerts %}
              <div class="mt-2">
                <a class="btn btn-success btn-sm w-100"
                   href="{{ url_for('scan_qr', interaction_id=ia.id) }}">
                   Scan Payment QR for {{ ia.user.name or ia.user.email }}
                </a>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
      {% if biz.status %}
        <div class="alert alert-info p-2 mb-3" style="font-size:1.09em; text-align:center;">
          Status: <strong>
            {% if biz.status == "not_submitted" %}
              Not Submitted
            {% elif biz.status == "pending" %}
              Pending Review
            {% elif biz.status == "in_review" %}
              In Review
            {% elif biz.status == "rejected" %}
              Rejected
            {% elif biz.status == "approved" %}
              Approved
            {% else %}
              {{ biz.status }}
            {% endif %}
          </strong>
        </div>
      {% endif %}
      <!-- Invite Modal stays unchanged... -->
      <div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <form class="modal-content" method="post" action="{{ url_for('business_invite') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="modal-header">
              <h5 class="modal-title" id="inviteModalLabel">Invite Others to Join PerkMiner</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <label for="invitee-email" class="form-label">Recipient's Email Address:</label>
              {{ invite_form.invitee_email(class="form-control", id="invitee-email", placeholder="Enter email to invite", required=True) }}
            </div>
            <div class="modal-footer">
              {{ invite_form.submit(class="btn btn-primary") }}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Profile Edit Section -->
    <div class="collapse mb-4" id="profileCollapse">
      <div class="card p-4">
        <h4>Your Profile</h4>
<form method="post" enctype="multipart/form-data" class="row g-3 align-items-center" id="profile-form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <!-- Profile Photo -->
  <div class="col-12 mb-3 text-center">
    {% if profile_img_url %}
      <img src="{{ profile_img_url }}" alt="Profile Photo" class="rounded-circle profile-pic">
    {% else %}
      <div class="placeholder-pic">No Image</div>
    {% endif %}
    <input type="file" name="profile_photo" accept="image/*" class="form-control mt-2">
  </div>

  <!-- Business Name -->
  <div class="col-12 mb-3">
    <label class="form-label">Business Name</label>
    <input type="text" class="form-control" name="business_name" value="{{ form_data.business_name }}" placeholder="Enter your business name">
  </div>

  <!-- Phone Number -->
  <div class="col-12 mb-3">
    <label class="form-label">Phone Number</label>
    <input type="text" class="form-control" id="us-phone" name="phone_number" value="{{ form_data.phone_number }}" placeholder="(555) 555-5555">
    <div class="form-text">Format: (555) 555-5555</div>
  </div>

  <!-- Business Address -->
  <div class="col-12 mb-3">
    <label class="form-label">Business Address</label>
    <input type="text" class="form-control" id="address-autocomplete" name="address" value="{{ form_data.address }}" placeholder="Business address" autocomplete="off">
  </div>

<!-- Address with Map in Profile Form -->
<div class="col-12 mb-3">
  <input type="hidden" name="latitude" id="latitude" value="{{ latitude or '' }}">
  <input type="hidden" name="longitude" id="longitude" value="{{ longitude or '' }}">
  <label class="form-label mt-2 mb-1 d-block">Pin or change your location on the map below:</label>
  <div id="profile-map" style="width:100%; height:300px; border-radius:8px; margin-bottom:12px;"></div>
</div>

  <div class="col-12 mb-3">
    <label class="form-label">Website</label>
    <input type="url" class="form-control" id="website_url" name="website_url" maxlength="255"
           value="{{ form_data.website_url }}" placeholder="https://your-website.com">
  </div>

  <!-- Services Offered Collapse -->
  <div class="col-12 mt-3">
   <button class="btn btn-outline-primary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#servicesCollapse" aria-expanded="false" aria-controls="servicesCollapse">
     Products or Services Offered (10 max)
     <br>(click to add product types and services)
   </button>
    <div class="collapse mt-2" id="servicesCollapse">
      <div id="services-list">
        {% set services = [
          form_data.service_1,
          form_data.service_2,
          form_data.service_3,
          form_data.service_4,
          form_data.service_5,
          form_data.service_6,
          form_data.service_7,
          form_data.service_8,
          form_data.service_9,
          form_data.service_10
        ] %}
        {% for s in range(0, 10) %}
          {% if services[s] or s < 2 %}
            <div class="input-group mb-2 service-field" data-index="{{ s }}">
              <input type="text" class="form-control" name="service_{{ s+1 }}" maxlength="100" placeholder="Service #{{ s+1 }}" value="{{ services[s] }}">
              <button class="btn btn-outline-danger service-remove" type="button" onclick="removeService(this)" {% if s < 2 %}disabled{% endif %}>&minus;</button>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      <button class="btn btn-outline-primary" type="button" id="addServiceBtn">+ Add Service</button>
      <small class="text-muted d-block mt-1">Max 10 services.</small>
    </div>
  </div>
  <div class="col-12 mb-3">
    <label class="form-label">About Us</label>
    <textarea class="form-control" id="about_us" name="about_us" rows="3" maxlength="1000" placeholder="Write about your business (max 1000 characters)">{{ form_data.about_us }}</textarea>
    <div class="form-text">Recommended: up to 500 characters. Max: 1000.</div>
  </div>
  <div class="col-12 mb-3">
    <label class="form-label">Listing Type <span class="text-danger">*</span></label>
    <select class="form-select" name="listing_type" required>
      <option value="">Select listing type...</option>
      <option value="Seller" {% if form_data.listing_type == 'Seller' %}selected{% endif %}>Seller</option>
      <option value="Service Provider" {% if form_data.listing_type == 'Service Provider' %}selected{% endif %}>Service Provider</option>
      <option value="Lead Generation" {% if form_data.listing_type == 'Lead Generation' %}selected{% endif %}>Lead Generation</option>
      <option value="Seller and Service Provider" {% if form_data.listing_type == 'Seller and Service Provider' %}selected{% endif %}>Seller and Service Provider</option>
    </select>
  </div>
  <div class="col-12 mb-3">
    <label class="form-label">Category</label>
    <select class="form-select" name="category" id="business_category" required>
      <option value="">Select category...</option>
      <option value="Handyman-Contractor" {% if form_data.category == 'Handyman-Contractor' %}selected{% endif %}>Handyman-Contractor</option>
      <option value="Auto Parts & Service" {% if form_data.category == 'Auto Parts & Service' %}selected{% endif %}>Auto Parts & Service</option>
      <option value="Home and Garden" {% if form_data.category == 'Home and Garden' %}selected{% endif %}>Home and Garden</option>
      <option value="Retail Outlet" {% if form_data.category == 'Retail Outlet' %}selected{% endif %}>Retail Outlet</option>
      <option value="Professional Services" {% if form_data.category == 'Professional Services' %}selected{% endif %}>Professional Services</option>
      <option value="Restaurant" {% if form_data.category == 'Restaurant' %}selected{% endif %}>Restaurant</option>
      <option value="Real Estate" {% if form_data.category == 'Real Estate' %}selected{% endif %}>Real Estate</option>
      <option value="Other" {% if form_data.category == 'Other' %}selected{% endif %}>Other</option>
    </select>
  </div>
  <!-- Keywords -->
  <div class="col-12 mt-3">
    <label class="form-label">Keywords (for search, separated by commas)</label>
    <input type="text" class="form-control" id="search_keywords" name="search_keywords" maxlength="500" value="{{ form_data.search_keywords }}" placeholder="e.g. roofing,solar,energy">
    <div class="form-text">Up to 20 keywords (comma-separated).</div>
  </div>

  <div class="col-12 mt-3 d-flex gap-2">
    {{ profile_form.submit(class="btn btn-success") }}
  </div>
</form>
      </div>
    </div>
  </div> <!-- end .card.mb-4.p-4 (dashboard main card) -->

  <!-- Referral Code Section -->
  <div class="card p-4 mb-4">
    <h4>Your Referral Code</h4>
    <div class="mb-0"><b>{{ referral_code }}</b></div>

  {% if sponsor %}

    <div>
      <small class="text-muted">Sponsored by: <span class="text-success">{{ sponsor.business_name }}</span></small></div>
    </div>
  {% endif %}

    <div>
      <button class="btn btn-success w-100" type="button" data-bs-toggle="modal" data-bs-target="#inviteModal">
        <i class="bi bi-person-plus me-1"></i>Invite others to join
      </button>
    </div>

  </div>

    <div class="card p-4 mb-4">
    <h4>Your Business Activity</h4>
    <div>
      <a href="{{ url_for('business_receipts') }}" class="btn btn-outline-secondary">View Receipts</a>
    </div>
  </div>

  <!-- Reward calculators and Network tree -->
  <div class="card p-4 mb-4">
    <h4>Estimate Your Rewards From One Single Paid Invoice</h4>
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-auto">
        <input id="reward_amount" type="number" class="form-control" placeholder="Amount (e.g. 500)" max="2500" required>
      </div>
      <div class="col-12 col-md-auto">
        <select id="reward_tier" class="form-select" required>
            <option value="1" selected>Tier 1 (your paid invoices)</option>
            <option value="2">Tier 2 (direct referral paid invoices)</option>
            <option value="3">Tier 3 (Tier 2 referral paid invoices)</option>
            <option value="4">Tier 4 (Tier 3 referral paid invoices)</option>
            <option value="5">Tier 5 (Tier 4 referral paid invoices)</option>
        </select>
      </div>
      <div class="col-12 col-md-auto">
        <button type="button" class="btn btn-primary" onclick="calculateSingleReward()">Calculate My Reward</button>
      </div>
    </div>
    <div id="rewards_output">
      {{ rewards_table | safe }}
    </div>
  </div>

  <div class="card p-4 mb-4">
    <h4>Referral Network Cashback Calculator (one paid invoice generated from every business in your network during the month)</h4>
    <div class="mb-2">
      <label>If you and everyone in your network refers 
        <input id="network_people" type="number" class="form-control d-inline-block w-auto" min="1" value="4" style="width:80px;" />
        businesses and you generate one paid invoice during the month in the amount of $ 
        <input id="network_amount" type="number" class="form-control d-inline-block w-auto" min="0" max="2500" step="0.01" value="100" style="width:110px;" />
        , this is how much your business would earn in Cashback Rewards for the month:
      </label>
      <small class="text-muted d-block">*Maximum purchase amount allowed is $2,500</small>
    </div>
    <button class="btn btn-info mb-2" type="button" onclick="calculateNetworkEarnings()">Calculate</button>
    <div id="network_results" style="display:none;">
      <ul class="mb-1">
        <li>Tier One: (Your paid invoices) = <span id="network_t1"></span></li>
        <li>Tier Two: (Paid invoices from your direct referrals) = <span id="network_t2"></span></li>
        <li>Tier Three: (Paid invoices from 2nd Tier referrals) = <span id="network_t3"></span></li>
        <li>Tier Four: (Paid invoices from 3rd Tier referrals) = <span id="network_t4"></span></li>
        <li>Tier Five: (Paid invoices from 4th Tier referrals) = <span id="network_t5"></span></li>
      </ul>
      <strong>Cash back earnings for your business for the month would be $<span id="network_total"></span></strong>
    </div>
  </div>
  <div class="card p-4 mb-4">
    <h4>My Network</h4>
    <div>
      <a role="button" class="fw-semibold text-primary" data-bs-toggle="collapse" href="#tier2" aria-expanded="false" aria-controls="tier2">
        Tier 2 (direct referrals)
      </a>
      <div class="collapse mt-2" id="tier2">
        {% if level2 %}
          <ul class="mb-2">{% for user in level2 %}<li>{{ user.email }} ({{ user.referral_code }})</li>{% endfor %}</ul>
        {% else %}
          <span>None</span>
        {% endif %}
      </div>
    </div>
    <div>
      <a role="button" class="fw-semibold text-primary" data-bs-toggle="collapse" href="#tier3" aria-expanded="false" aria-controls="tier3">
        Tier 3 (referred by Tier 2 people)
      </a>
      <div class="collapse mt-2" id="tier3">
        {% if level3 %}
          <ul class="mb-2">{% for user in level3 %}<li>{{ user.email }} ({{ user.referral_code }})</li>{% endfor %}</ul>
        {% else %}
          <span>None</span>
        {% endif %}
      </div>
    </div>
    <div>
      <a role="button" class="fw-semibold text-primary" data-bs-toggle="collapse" href="#tier4" aria-expanded="false" aria-controls="tier4">
        Tier 4 (referred by Tier 3 people)
      </a>
      <div class="collapse mt-2" id="tier4">
        {% if level4 %}
          <ul class="mb-2">{% for user in level4 %}<li>{{ user.email }} ({{ user.referral_code }})</li>{% endfor %}</ul>
        {% else %}
          <span>None</span>
        {% endif %}
      </div>
    </div>
    <div>
      <a role="button" class="fw-semibold text-primary" data-bs-toggle="collapse" href="#tier5" aria-expanded="false" aria-controls="tier5">
        Tier 5 (referred by Tier 4 people)
      </a>
      <div class="collapse mt-2" id="tier5">
        {% if level5 %}
          <ul class="mb-2">{% for user in level5 %}<li>{{ user.email }} ({{ user.referral_code }})</li>{% endfor %}</ul>
        {% else %}
          <span>None</span>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="card p-4 text-center">
    <h4>This is your dashboard.</h4>
    <p class="mb-0">Congrats on registering your business with PerkMiner!</p>
  </div>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-warning mt-3">
        {% for message in messages %}
          {{ message }}<br>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
</div>
<footer>
  <div>
    <div class="mb-2">
      <a href="/" style="color:var(--pm-primary);font-weight:600;text-decoration:none;">PerkMiner</a> &copy; 2026
    </div>
    <div>
      <small>Need help? <a href="mailto:support@perkminer.com" style="color:var(--pm-primary);">Contact Support</a></small>
    </div>
    <div class="mt-1">
      <a href="#" style="color:#3dbbee; margin:0 6px;text-decoration:none;">Privacy</a>
      <a href="#" style="color:#3dbbee; margin:0 6px;text-decoration:none;">Terms</a>
    </div>
  </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Preview Listing Modal -->
    <div class="modal fade" id="listingPreviewModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Profile Preview</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="listing-preview-content">
            {% if biz.status in ["not_submitted", "approved"] and (
              biz.draft_business_name or
              biz.draft_category or
              biz.draft_profile_photo or
              biz.draft_phone_number or
              biz.draft_address or
              biz.draft_latitude or
              biz.draft_longitude or
              biz.draft_hours_of_operation or
              biz.draft_website_url or
              biz.draft_about_us or
              biz.draft_service_1 or biz.draft_service_2 or biz.draft_service_3 or
              biz.draft_service_4 or biz.draft_service_5 or biz.draft_service_6 or
              biz.draft_service_7 or biz.draft_service_8 or biz.draft_service_9 or
              biz.draft_service_10 or biz.draft_search_keywords
            ) %}
            <form method="post" action="{{ url_for('listing_disclaimer') }}" class="mb-3 mt-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="listing_id" value="{{ biz.id }}">
              <input type="hidden" name="referral_code" value="{{ biz.referral_code }}">
              <button type="submit" class="btn btn-warning w-100 mb-2">Submit for Review</button>
            </form>
            {% endif %}
            <!-- Your JS will fill in the rest of this div at runtime, below this form -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    window.addEventListener('DOMContentLoaded', function() {
      let previewBtn = document.getElementById('previewListingBtn');
      let modal = document.getElementById('listingPreviewModal');
      let modalContent = document.getElementById('listing-preview-content');
      let previewModal = modal && window.bootstrap ? new bootstrap.Modal(modal) : null;

      previewBtn && previewBtn.addEventListener('click', function(){
        let name = document.querySelector('[name="business_name"]')?.value || {{ biz.business_name | tojson }};
        let address = document.getElementById('address-autocomplete')?.value || {{ biz.address | tojson }};
        let category = document.getElementById('business_category')?.value || {{ biz.category | tojson }};
        let phone = document.getElementById('us-phone')?.value || {{ biz.phone_number | tojson }};
        let website = document.getElementById('website_url')?.value || {{ biz.website_url | tojson }};
        let about = document.getElementById('about_us')?.value || {{ biz.about_us | tojson }};
        let keywords = document.getElementById('search_keywords')?.value || {{ biz.search_keywords | tojson }};
        let services = [];
        document.querySelectorAll('#services-list input').forEach(input => {
          if(input.value.trim()!="") services.push(input.value.trim());
        });
        let img = {{ (profile_img_url if profile_img_url else "") | tojson }};

        let smallListing = `
          <div class="card mb-3">
            <div class="row g-0 align-items-center">
              <div class="col-md-3 text-center">
                ${img? `<img src="${img}" class="rounded-circle" style="width:60px;height:60px;object-fit:cover;">` : ""}
              </div>
              <div class="col-md-9">
                <b>${name}</b><br/>
                <span class="text-muted">${category}</span><br/>
                <span>${address}</span><br/>
                <small>Services: ${services.length ? services.join(', ') : 'N/A'}</small>
              </div>
            </div>
          </div>
        `;
        let largeListing = `
          <div>
            ${img? `<div class="mb-3 text-center"><img src="${img}" class="rounded-circle" style="width:120px;height:120px;object-fit:cover;"></div>` : ""}
            <h3>${name}</h3>
            <div><strong>Category:</strong> ${category}</div>
            <div><strong>Address:</strong> ${address}</div>
            <div id="preview-map" style="width:100%;height:150px;border-radius:8px;margin:8px 0;"></div>
            <div><strong>Phone:</strong> ${phone}</div>
            <div><strong>Website:</strong> ${website? `<a href="${website}" target="_blank">${website}</a>` : '-'}</div>
            <div><strong>Email:</strong> {{ biz.business_email }}</div>
            <div><strong>About us:</strong> ${about}</div>
            <div><strong>Services:</strong> ${services.length ? "<ul>" + services.map(s=>`<li>${s}</li>`).join('') + "</ul>" : "N/A"}</div>
          </div>
        `;

        let html = `
          <h5>Small Listing Preview</h5>
          ${smallListing}
          <hr/>
          <h5>Large Listing Preview</h5>
          ${largeListing}
        `;
        // Only replace what follows the form in the modal body.
        let modalForm = modalContent.querySelector('form');
        modalContent.innerHTML = (modalForm ? modalForm.outerHTML : '') + html;
        setTimeout(function() {
          let lat = Number(document.getElementById('latitude')?.value) || 39.8283;
          let lng = Number(document.getElementById('longitude')?.value) || -98.5795;
          if (window.google && document.getElementById('preview-map')) {
            let previewMap = new google.maps.Map(document.getElementById('preview-map'), {
              center: {lat: lat, lng: lng},
              zoom: 16
            });
            new google.maps.Marker({position: {lat: lat, lng: lng}, map: previewMap});
          }
        }, 200);
        previewModal && previewModal.show();
      });
    });
    </script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const servicesList = document.getElementById('services-list');
  const addServiceBtn = document.getElementById('addServiceBtn');

  function countServiceFields() {
    return servicesList.querySelectorAll('.service-field').length;
  }

  addServiceBtn.addEventListener('click', function() {
    let current = countServiceFields();
    if (current < 10) {
      // Create the new input div
      const div = document.createElement('div');
      div.className = 'input-group mb-2 service-field';
      div.setAttribute('data-index', current);

      // Create input
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control';
      input.name = 'service_' + (current + 1);
      input.maxLength = 100;
      input.placeholder = 'Service #' + (current + 1);

      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-outline-danger service-remove';
      removeBtn.innerHTML = '&minus;';
      removeBtn.addEventListener('click', function() {
        if (current > 2) div.remove();
      });

      div.appendChild(input);
      div.appendChild(removeBtn);

      servicesList.appendChild(div);
    }
    if (countServiceFields() >= 10) {
      addServiceBtn.disabled = true;
    }
  });

  servicesList.querySelectorAll('.service-remove').forEach(btn => {
    btn.addEventListener('click', function() {
      // Only allow remove for fields > 2
      if (countServiceFields() > 2 && !btn.disabled) {
        btn.parentElement.remove();
        addServiceBtn.disabled = false;
      }
    });
  });
});
</script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDo-AojTUQUwwvvywrSiDRcF-oVpw9m_w4&libraries=places"></script>
    <script>
function initProfileMap() {
  const latInput = document.getElementById('latitude');
  const lngInput = document.getElementById('longitude');
  let lat = parseFloat(latInput.value) || 39.8283;  // Default US center
  let lng = parseFloat(lngInput.value) || -98.5795;
  let mapDiv = document.getElementById('profile-map');
  if (!mapDiv) return;

  let map = new google.maps.Map(mapDiv, {
    center: {lat: lat, lng: lng},
    zoom: (latInput.value && lngInput.value) ? 16 : 4
  });
  let marker = new google.maps.Marker({
    position: {lat: lat, lng: lng},
    map: map,
    draggable: true
  });

  // Drag the marker to update fields
  marker.addListener('dragend', function(event) {
    latInput.value = event.latLng.lat();
    lngInput.value = event.latLng.lng();
  });

  // Clicking the map sets the marker and updates fields
  map.addListener('click', function(e) {
    marker.setPosition(e.latLng);
    latInput.value = e.latLng.lat();
    lngInput.value = e.latLng.lng();
  });

  // Autocomplete logic
  const addressInput = document.getElementById('address-autocomplete');
  if (addressInput) {
    let autocomplete = new google.maps.places.Autocomplete(addressInput, { types: ['geocode'] });
    autocomplete.addListener('place_changed', function () {
      let place = autocomplete.getPlace();
      if (!place.geometry) return;
      let loc = place.geometry.location;
      latInput.value = loc.lat();
      lngInput.value = loc.lng();
      marker.setPosition(loc);
      map.setCenter(loc);
      map.setZoom(16);
    });
  }
}

window.addEventListener('DOMContentLoaded', function() {
  if(window.google && google.maps) {
    initProfileMap();
  } else {
    // Ensure map initializes after API loads
    window.initProfileMap = initProfileMap;
  }
});
</script>
</body>
</html>