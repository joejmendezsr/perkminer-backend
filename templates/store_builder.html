<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store Website Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="styles/tokens.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/swiper@11.1.4/swiper-bundle.min.css">
  <style>
    body { 
      background: var(--color-bg); 
      color: var(--color-text); 
      min-height: 100vh; 
      font-family: var(--font-main); 
    }
    .builder-toolbar { background: #21253b; box-shadow: 0 4px 18px #002f5988; border-radius: 13px; max-width:1350px; margin:24px auto 10px auto; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; padding:0.6em 2em;}
    .builder-title { font-size: 1.7em; font-weight: bold; background: linear-gradient(93deg, #6afadc, #db8abf, #50cdc1, #5b8dfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;}
    .theme-toggle { background:#1a293c; color:#89c5ff;border-radius:5px;border:2px solid #2f81d8; padding:5px 17px; font-size:1em; cursor:pointer;}
    .page-bar {gap: 1.1em; padding: 0.2em 0;}
    .page-btn {background: #22253a; color: #8ad6f6; border: 1.5px solid #498bf0; border-radius:6px; font-weight:500; padding:4.5px 13px; font-size:1.08em; cursor:pointer;}
    .page-btn.active, .page-btn:focus {background:#3657a8; color:#ffe25a; border-color: #db8abf;}
    #builder-main-row {display:flex; gap:32px; max-width:1280px; margin:auto;}
    #gjs-sidebar {flex-shrink:0;width:175px; background:rgba(14,27,53,0.97); box-shadow: 0 2px 14px #12233eaa; border-radius: 12px; padding:22px 7px 17px 7px; margin-top: 10px;}
    #gjs { flex:1 1 0px; border-radius: 13px; background: #f6fbfd; box-shadow: 0 8px 48px #03253621; border: 2.5px solid #4373b7; min-height:72vh; margin-bottom:2rem;}
    .block-list { list-style:none; margin:0; padding:0;}
    .block-list li { margin-bottom: 1.05rem; }
    .block-btn { display:flex; align-items:center; gap:7px; background:#111821; border:1.6px solid #5693e0; border-radius:7px; padding:5.5px 8px; font-size:0.98em; color:#ace0fa; cursor:move; box-shadow:0 2px 7px #163a66ad; transition: background .13s, color .13s, border .13s;}
    .block-btn:hover { background:#2659cf; color:#ffedbd; border:1.7px solid #e4adf7;}
    .block-btn .bi { font-size:1.12em;}
    .theme-gallery-wrap {background:#181b24; border-radius:15px; box-shadow:0 2px 14px #0a112084; max-width:1220px; margin:10px auto 3rem auto; padding:22px 18px;}
    .theme-gallery-title { color:#5bddff;font-size:1.3em;font-weight:700;}
    .theme-gallery-row {display:flex;gap:1.1em;flex-wrap:wrap;justify-content:center;}
    .theme-preview-card {width:200px;background:#fff;border-radius:10px;box-shadow:0 2px 14px #89caf029;margin-bottom:16px;}
    .theme-preview-thumb {width:100%;height:108px;object-fit:cover;border-top-left-radius:10px;border-top-right-radius:10px;}
    .theme-preview-title {font-weight:700;font-size:1.06em;color:#262e40;padding:0.51em 0 0 1.0em;text-align:left;}
    .theme-preview-desc {font-size:.93em;color:#4a5979;min-height:36px;padding:0 1em 0.9em 1em;text-align:left;}
    .theme-preview-btn {
      display: block;
      width: 92%;
      margin: 1em auto 1.1em auto;   /* Center horizontally and space vertically */
      background: #ffca2c;
      color: #181b24 !important;
      border-radius: 7px;
      border: 2px solid #ffd05b;
      padding: 12px 0;
      text-align: center;
      font-weight: 700;
      font-size: 1.09em;
      box-shadow: 0 2px 8px #ffe47242;
      letter-spacing: .01em;
      cursor: pointer;
      transition: box-shadow .16s, background .15s, color .12s;
    }
    .theme-preview-btn:hover {
      background: #ffe484;
      color: #222;
      box-shadow: 0 6px 18px #ffe77c88;
      border-color: #ffd05b;
    }
    
    @media (max-width:1000px) { #builder-main-row { flex-direction:column; gap:13px;} #gjs-sidebar {width:100%;margin-bottom:12px;} #gjs {min-height:42vh;} }
    @media (max-width:600px) { .builder-toolbar {flex-direction:column;gap:6px;padding:1em 0.5em;} #gjs-sidebar{padding:14px 2px;} }
  </style>
</head>
<body>
<div class="builder-toolbar">
  <span class="builder-title"><i class="bi bi-cpu me-1"></i> Store Website Builder</span>
  <div class="page-bar">
    <button class="page-btn active" data-page="home">Home Page</button>
    <button class="page-btn" data-page="products">Products</button>
    <button class="page-btn" data-page="contact">Contact</button>
    </div>
    <button class="theme-toggle" id="themeToggle"><i class="bi bi-lightbulb"></i> Switch Color Scheme</button>
    </div>
    <div id="builder-main-row">
      <div id="gjs-sidebar">
        <div class="fw-semibold mb-2" style="color:#75fff0;letter-spacing:1px;">Elements</div>
        <ul class="block-list">
      <li>
        <div class="block-btn" id="btn-image-menu">Image</div>
        <ul class="sub-list" id="sub-image" style="display:none; margin-top:7px;">
          <!-- sub-buttons go here -->
        </ul>
      </li>
      <li>
        <div class="block-btn" id="btn-layout-menu">Layout</div>
        <ul class="sub-list" id="sub-layout" style="display:none; margin-top:7px;"></ul>
      </li>
      <li>
        <div class="block-btn" id="btn-multilayer-menu">Multi-Layer</div>
        <ul class="sub-list" id="sub-multilayer" style="display:none; margin-top:7px;"></ul>
      </li>
      <li>
        <div class="block-btn" id="btn-text-menu">Text</div>
        <ul class="sub-list" id="sub-text" style="display:none; margin-top:7px;"></ul>
      </li>
      <li>
        <div class="block-btn" id="btn-menu-menu">Menu</div>
        <ul class="sub-list" id="sub-menu" style="display:none; margin-top:7px;"></ul>
      </li>
      <li>
        <div class="block-btn" id="btn-custom-menu">Customization</div>
        <ul class="sub-list" id="sub-custom" style="display:none; margin-top:7px;"></ul>
      </li>
    </ul>
  </div>
  <div id="gjs" style="height:540px;"></div>
</div>
<!-- THEME GALLERY BELOW BUILDER -->
<div class="theme-gallery-wrap mb-5">
  <div class="theme-gallery-title mb-3">⭐ Or pick a full-page template (click "Load"):</div>
  <div class="theme-gallery-row">
    {% for theme in themes %}
      <div class="theme-preview-card">
        <img class="theme-preview-thumb" src="{{ theme.thumbnail_url or 'https://via.placeholder.com/206x120.png?text=Theme' }}" alt="{{ theme.name }}">
        <div class="theme-preview-title">{{ theme.name }}</div>
        <div class="theme-preview-desc">
          {{ theme.starter_html|striptags|truncate(90, True, '...')|e }}
        </div>
        <button class="theme-preview-btn" onclick="loadBuilderTheme('{{ theme.id }}')">Load</button>
      </div>
    {% endfor %}
  </div>
</div>
<form id="save-html-form" method="POST" action="">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="page_html" id="page_html">
  <input type="hidden" name="page" id="current_page">
  <button type="submit" class="btn btn-success mt-3 ms-1">Save Website</button>
  <a href="{{ url_for('store_admin') }}" class="btn btn-secondary mt-3 ms-2">Back to Store Admin</a>
</form>
<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/swiper@11.1.4/swiper-bundle.min.js"></script>
<script>
  document.getElementById('themeToggle').addEventListener('click', function() {
    document.body.classList.toggle('dark-theme');
    this.classList.toggle('active');
  });

  // Multi-page logic and save
  const pages = { home: `{{ saved_html | safe }}`, products: '', contact: '' };
  let currentPageKey = 'home';
  function loadPage(pageKey) {
    currentPageKey = pageKey;
    editor.setComponents(pages[pageKey] || '');
    document.getElementById('current_page').value = currentPageKey;
    document.querySelectorAll('.page-btn').forEach(btn =>
      btn.classList.toggle('active', btn.dataset.page === pageKey)
    );
  }
  document.querySelectorAll('.page-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      pages[currentPageKey] = editor.getHtml();
      loadPage(btn.dataset.page);
    });
  });

  // Theme gallery logic
  const themeHtmlMap = {{ theme_html_map | safe }};
  function loadBuilderTheme(themeId) {
    editor.setComponents(themeHtmlMap[themeId] || '');
    pages[currentPageKey] = themeHtmlMap[themeId] || '';
  }

  // GrapesJS init—only the work area is inside #gjs (sidebar is native, not HTML)
  let defaultHTML = `<section style="padding:44px 0;text-align:center;background:#f8faff;"><h2>Welcome!</h2><p>Drag blocks from the left into your site.</p></section>`;
  const editor = grapesjs.init({
    container: '#gjs',
    fromElement: false,
    height: '540px',
    width: 'auto',
    storageManager: false,
    plugins: [],
    components: pages['home'] || defaultHTML,
    style: '',
  });

  function addBlock(html) { editor.addComponents(html); pages[currentPageKey] = editor.getHtml(); }
  function initDraggableBlock(btnId, html) {
    const btn = document.getElementById(btnId);
    btn.setAttribute('draggable','true');
    btn.addEventListener('dragstart', function(e){ e.dataTransfer.setData('text', html); });
    btn.addEventListener('click', function(){ addBlock(html); });
  }

  // --- Add all block types ---
  initDraggableBlock('block-hero', `<section style="padding:50px 0;text-align:center;background:#eaf6fd;"><h2>Big Welcome Here!</h2><p>Your main message for customers.</p></section>`);
  initDraggableBlock('block-img', `<img src="https://via.placeholder.com/400x200.png?text=Add+Image" style="width:100%;max-width:440px;border-radius:11px;margin:18px auto;display:block;">`);
  initDraggableBlock('block-paragraph', `<div class="py-3" style="max-width:560px;margin:auto;"><p>Tell your story or describe your offers here.</p></div>`);
  initDraggableBlock('block-products', `<div class="mx-auto my-3" style="max-width:950px;"><h3 class="mb-3 text-center">Featured Products</h3><div style="display:flex;flex-wrap:wrap;gap:1.4rem;justify-content:center;"><div style="width:220px;" class="p-3 border rounded bg-light"><img src="https://via.placeholder.com/200x130.png?text=Product+1" style="width:100%;border-radius:7px;"><div class="fw-semibold mt-2">Product Name</div><div class="text-success mb-1">$19.95</div></div><div style="width:220px;" class="p-3 border rounded bg-light"><img src="https://via.placeholder.com/200x130.png?text=Product+2" style="width:100%;border-radius:7px;"><div class="fw-semibold mt-2">Product Name</div><div class="text-success mb-1">$24.99</div></div></div></div>`);
  initDraggableBlock('block-row-lr', `<div style="display:flex;gap:22px;align-items:center;max-width:900px;margin:38px auto;"><img src="https://via.placeholder.com/250x150.png?text=Image" style="width:44%;border-radius:13px;"><div><h4>Describe it here.</h4><p>Your text goes here.</p></div></div>`);
  initDraggableBlock('block-row-rl', `<div style="display:flex;gap:22px;align-items:center;max-width:900px;margin:38px auto;"><div><h4>More Info</h4><p>Paragraph text here.</p></div><img src="https://via.placeholder.com/250x150.png?text=Image" style="width:44%;border-radius:13px;"></div>`);
  initDraggableBlock('block-slider', `<div class="swiper mySwiper" style="max-width:600px;margin:40px auto;"><div class="swiper-wrapper"><div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+1" style="width:100%;border-radius:10px;"></div><div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+2" style="width:100%;border-radius:10px;"></div><div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+3" style="width:100%;border-radius:10px;"></div></div><div class="swiper-pagination"></div></div><script>try{ new Swiper('.mySwiper', {pagination:{el:'.swiper-pagination',clickable:true},loop:true}); }catch(err) {}<\/script>`);
  initDraggableBlock('block-testimonial', `<blockquote style="max-width:560px;margin:2.5rem auto;padding:20px 26px;background:#f9f6eb;border-left:5px solid #ffd66b;border-radius:10px;"><div style="font-size:1.15em;font-style:italic;">“Amazing service! Quick, easy, and just what my family needed.”</div><hr><div style="color:#9a8965;font-weight:600;">– Happy Customer</div></blockquote>`);
  initDraggableBlock('block-contact', `<section style="padding:35px 0;text-align:center;"><div style="max-width:500px;margin:auto"><h4>Contact Us</h4><form><input type="text" placeholder="Your Name" class="form-control mb-2"><input type="email" placeholder="Your Email" class="form-control mb-2"><textarea class="form-control mb-2" placeholder="Message"></textarea><button class="btn btn-primary">Send Message</button></form></div></section>`);
  initDraggableBlock('block-header', `<header class="mb-4" style="background:#222333;color:white;padding:16px 7px;border-radius:8px;text-align:center;"><h2 style="font-weight:900;font-size:2em;">My Store</h2><nav><a href="#" class="mx-2" style="color:#8ef0fd;">Home</a><a href="#" class="mx-2" style="color:#8ef0fd;">Shop</a><a href="#" class="mx-2" style="color:#8ef0fd;">Contact</a></nav></header>`);
  initDraggableBlock('block-footer', `<footer style="background:#1a2239;color:#89c6ec;padding:22px 12px;margin-top:24px;"><div style="text-align:center;">&copy; 2026 My Store. All rights reserved.</div></footer>`);
  initDraggableBlock('block-divider', `<hr style="margin:40px 0;border:0;height:2px;background:linear-gradient(90deg,transparent,#9cf 60%,transparent 100%);">`);
  initDraggableBlock('block-btn', `<a href="#" class="btn btn-primary">Click Me</a>`);
  initDraggableBlock('block-map', `<div style="width:100%;max-width:430px;margin:18px auto;"><iframe width="100%" height="180" style="border-radius:11px;border:0" src="https://maps.google.com/maps?q=Springfield&t=&z=13&ie=UTF8&iwloc=&output=embed"></iframe></div>`);

  document.getElementById('save-html-form').addEventListener('submit', function(e){
    pages[currentPageKey] = editor.getHtml();
    document.getElementById('page_html').value = pages[currentPageKey];
    document.getElementById('current_page').value = currentPageKey;
  });

  // Home is initial
  loadPage('home');
</script>
// Toggle sidebar sub-menus
[
  ['btn-image-menu','sub-image'],
  ['btn-layout-menu','sub-layout'],
  ['btn-multilayer-menu','sub-multilayer'],
  ['btn-text-menu','sub-text'],
  ['btn-menu-menu','sub-menu'],
  ['btn-custom-menu','sub-custom']
].forEach(pair => {
  const [btnId, subId] = pair;
  const btn = document.getElementById(btnId);
  const sub = document.getElementById(subId);
  btn.addEventListener('click', () => {
    // Close other submenus
    document.querySelectorAll('.sub-list').forEach(lst => { if(lst!==sub) lst.style.display='none'; });
    // Toggle this one
    sub.style.display = (sub.style.display === 'none') ? 'block' : 'none';
  });
});
</body>
</html>