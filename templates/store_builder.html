<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store Website Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Hi-tech gradient and dark UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(120deg, #151e28 0%, #203b4e 100%);
      color: #e9f2fb;
      min-height: 100vh;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    .builder-toolbar {
      background: linear-gradient(90deg, #141927 0%, #29526f 99%);
      box-shadow: 0 4px 24px #00111980;
      border-radius: 13px;
      max-width: 1200px;
      margin: 24px auto 16px auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 0.55em 2.1em 0.45em 1.6em;
    }
    .builder-title {
      font-size: 1.7em;
      font-weight: bold;
      letter-spacing: 1px;
      background: linear-gradient(90deg, #6afadc, #50cdc1, #5b8dfa, #db8abf);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .theme-toggle {
      background: #101a28;
      color: #89c5ff;
      border-radius: 6px;
      border: 2px solid #2f81d8;
      cursor: pointer;
      padding: 5px 18px;
      margin-left: 1em;
      font-size: 1em;
      transition: background 0.23s, color 0.23s;
    }
    .theme-toggle.active {
      background: #223d60;
      color: #ffe25a;
      border-color: #db8abf;
    }
    .page-bar {
      display: flex;
      gap: 1.3em;
      align-items: center;
      margin-top: 0.15em;
    }
    .page-btn {
      background: #262a40;
      color: #8ad6f6;
      border: 1.5px solid #498bf0;
      border-radius: 6px;
      font-weight: 500;
      padding: 4px 14px;
      margin-right: 4px;
      font-size: 1.03em;
      cursor: pointer;
    }
    .page-btn.active, .page-btn:focus { background: #3e5388; color: #ffe25a; border-color: #db8abf; }
    #builder-main-row { display:flex; gap:34px; max-width:1260px; margin:auto; }
    #gjs-sidebar {
      flex-shrink:0;
      width:225px;
      background:rgba(21,35,67,0.97);
      box-shadow: 0 2px 14px #12233eaa;
      border-radius: 12px;
      padding: 26px 12px 24px 12px;
      margin-top: 10px;
    }
    #gjs {
      flex:1 1 0px;
      border-radius: 12px;
      box-shadow: 0 6px 36px #112434;
      min-height: 74vh;
      background: #0d121c;
      border: 1.5px solid #4679e3;
      margin-bottom: 2rem;
    }
    .block-list { list-style:none; margin:0; padding:0;}
    .block-list li { margin-bottom: 1.2rem; }
    .block-btn {
      display: flex; align-items: center; gap: 11px;
      background: #101d30;
      border: 1.5px solid #567bd8;
      border-radius:8px;
      padding: 9px 19px 9px 13px;
      font-size: 1em;
      color: #ace0fa;
      cursor: move;
      box-shadow:0 2px 8px #163a66ad;
      transition: background 0.13s, color 0.13s, border 0.13s;
    }
    .block-btn:hover { background: #2659cf; color: #fff; border: 1.5px solid #e4adf7;}
    .block-btn .bi { font-size:1.19em;}
    @media (max-width:1000px) {
      #builder-main-row { flex-direction:column; gap:12px; }
      #gjs-sidebar { width:100%; margin-bottom:14px;}
      #gjs { min-height:42vh;}
    }
    @media (max-width:600px) {
      .builder-toolbar { flex-direction:column; gap:5px; padding:1em 0.5em;}
      #gjs-sidebar { padding:15px 2px; }
    }
  </style>
</head>
<body>
<div class="builder-toolbar">
  <span class="builder-title"><i class="bi bi-cpu me-1"></i> Store Website Builder</span>
  <div class="page-bar">
    <button class="page-btn active" data-page="home">Home Page</button>
    <button class="page-btn" data-page="page2">Page 2</button>
    <button class="page-btn" data-page="page3">Page 3</button>
  </div>
  <button class="theme-toggle" id="themeToggle"><i class="bi bi-lightbulb"></i> Switch Color Scheme</button>
</div>
<div id="builder-main-row">
  <div id="gjs-sidebar">
      <div class="fw-semibold mb-2" style="color:#75fff0;letter-spacing:1px;">Elements</div>
      <ul class="block-list">
        <li><div class="block-btn" id="block-hero"><i class="bi bi-star"></i> Hero section</div></li>
        <li><div class="block-btn" id="block-img"><i class="bi bi-image"></i> Image</div></li>
        <li><div class="block-btn" id="block-paragraph"><i class="bi bi-align-left"></i> Paragraph</div></li>
        <li><div class="block-btn" id="block-products"><i class="bi bi-collection"></i> Product Grid</div></li>
        <li><div class="block-btn" id="block-testimonial"><i class="bi bi-chat-quote"></i> Testimonial</div></li>
        <li><div class="block-btn" id="block-contact"><i class="bi bi-envelope"></i> Contact Form</div></li>
        <li><div class="block-btn" id="block-header"><i class="bi bi-window"></i> Header/Nav Bar</div></li>
        <li><div class="block-btn" id="block-footer"><i class="bi bi-strava"></i> Footer</div></li>
        <li><div class="block-btn" id="block-divider"><i class="bi bi-dash-lg"></i> Divider</div></li>
        <li><div class="block-btn" id="block-btn"><i class="bi bi-square"></i> Button</div></li>
        <li><div class="block-btn" id="block-map"><i class="bi bi-geo-alt"></i> Map</div></li>
      </ul>
  </div>
  <div id="gjs" style="height:480px;"></div>
</div>
<form id="save-html-form" method="POST" action="">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="page_html" id="page_html">
  <button type="submit" class="btn btn-success mt-3 ms-1">Save Website</button>
  <a href="{{ url_for('store_admin') }}" class="btn btn-secondary mt-3 ms-2">Back to Store Admin</a>
</form>

<script src="https://unpkg.com/grapesjs"></script>
<script>
  // Theme switcher (simple color class swap—expand for more schemes)
  const toggleBtn = document.getElementById('themeToggle');
  toggleBtn.addEventListener('click', function() {
    document.body.classList.toggle('dark-theme');
    toggleBtn.classList.toggle('active');
    // Extend: change GrapesJS CSS too if you want
  });

  // Multi-page logic (simple in-memory for now; expand with backend persist as needed)
  const pages = { home: `{{ saved_html | safe }}`, page2: '', page3: '' };
  let currentPageKey = 'home';

  function loadPage(pageKey) {
    currentPageKey = pageKey;
    editor.setComponents(pages[pageKey] || '');
    document.querySelectorAll('.page-btn').forEach(btn =>
      btn.classList.toggle('active', btn.dataset.page === pageKey)
    );
  }
  document.querySelectorAll('.page-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Save current page HTML before switching
      pages[currentPageKey] = editor.getHtml();
      loadPage(btn.dataset.page);
    });
  });

  // Map of theme_id => starter_html from Flask
  const themeHtmlMap = {{ theme_html_map | safe }};
  let defaultHTML = `<section style="padding:40px 0;text-align:center;background:#f8faff;"><h2>Welcome to Your Store</h2><p>Drag content to start building your front page.</p></section>`;
  const editor = grapesjs.init({
    container: '#gjs',
    fromElement: false,
    height: '480px',
    width: 'auto',
    storageManager: false,
    plugins: [],
    components: pages['home'] || defaultHTML,
    style: '',
    blockManager: { appendTo: null }
  });

  // Helper: Add block to current page (preserves per-page)
  function addBlock(html) {
    editor.addComponents(html);
    // Save immediately
    pages[currentPageKey] = editor.getHtml();
  }

  // Drag-and-drop block sidebar, powered by GrapesJS
  function initDraggableBlock(btnId, html) {
    const btn = document.getElementById(btnId);
    btn.setAttribute('draggable', 'true');
    btn.addEventListener('dragstart', function(e) {
      e.dataTransfer.setData('text', html);
    });
    btn.addEventListener('click', function() {
      addBlock(html); // also allow click-to-add
    });
  }
  initDraggableBlock('block-hero', `<section style="padding:50px 0;text-align:center;background:#eaf6fd;">
    <h2 class="mb-2" style="font-size:2.15em;font-weight:800;">Welcome to Our Store!</h2>
    <p style="font-size:1.25em;">Drag elements to build your business page.</p>
    <a href="#products" class="btn btn-primary btn-lg mt-2">Shop Now</a>
  </section>`);
  initDraggableBlock('block-img', `<img src="https://via.placeholder.com/400x200.png?text=Your+Image" style="width:100%;max-width:440px;border-radius:11px;margin:18px auto;display:block;">`);
  initDraggableBlock('block-paragraph', `<div class="py-3" style="max-width:560px;margin:auto;">
    <p style="font-size:1.1em;">Describe your business, add info or details here.</p>
  </div>`);
  initDraggableBlock('block-products', `<div class="mx-auto my-3" style="max-width:950px;">
    <h3 class="mb-3 text-center">Featured Products</h3>
    <div style="display:flex;flex-wrap:wrap;gap:1.4rem;justify-content:center;">
      <div style="width:220px;" class="p-3 border rounded bg-light">
        <img src="https://via.placeholder.com/200x130.png?text=Product+1" style="width:100%;border-radius:7px;">
        <div class="fw-semibold mt-2">Product Name</div>
        <div class="text-success mb-1">$19.95</div>
      </div>
      <div style="width:220px;" class="p-3 border rounded bg-light">
        <img src="https://via.placeholder.com/200x130.png?text=Product+2" style="width:100%;border-radius:7px;">
        <div class="fw-semibold mt-2">Product Name</div>
        <div class="text-success mb-1">$24.99</div>
      </div>
    </div>
  </div>`);
  initDraggableBlock('block-testimonial', `<blockquote style="max-width:560px;margin:2.5rem auto;padding:20px 26px;background:#f9f6eb;border-left:5px solid #ffd66b;border-radius:10px;">
      <div style="font-size:1.15em;font-style:italic;">“Amazing service! Quick, easy, and just what my family needed.”</div>
      <hr>
      <div style="color:#9a8965;font-weight:600;">– Happy Customer</div>
    </blockquote>`);
  initDraggableBlock('block-contact', `<section style="padding:35px 0;text-align:center;">
    <div style="max-width:500px;margin:auto">
      <h4>Contact Us</h4>
      <form><input type="text" placeholder="Your Name" class="form-control mb-2">
      <input type="email" placeholder="Your Email" class="form-control mb-2">
      <textarea class="form-control mb-2" placeholder="Message"></textarea>
      <button class="btn btn-primary">Send Message</button></form>
    </div>
  </section>`);
  initDraggableBlock('block-header', `<header class="mb-4" style="background:#222333;color:white;padding:16px 7px;border-radius:8px;text-align:center;">
    <h2 style="font-weight:900;font-size:2em;">My Store</h2>
    <nav><a href="#" class="mx-2" style="color:#8ef0fd;">Home</a><a href="#" class="mx-2" style="color:#8ef0fd;">Shop</a><a href="#" class="mx-2" style="color:#8ef0fd;">Contact</a></nav>
  </header>`);
  initDraggableBlock('block-footer', `<footer style="background:#1a2239;color:#89c6ec;padding:22px 12px;margin-top:24px;">
    <div style="text-align:center;">&copy; 2026 My Store. All rights reserved.</div></footer>`);
  initDraggableBlock('block-divider', `<hr style="margin:40px 0;border:0;height:2px;background:linear-gradient(90deg,transparent,#9cf 60%,transparent 100%);">`);
  initDraggableBlock('block-btn', `<a href="#" class="btn btn-primary">Click Me</a>`);
  initDraggableBlock('block-map', `<div style="width:100%;max-width:430px;margin:18px auto;">
    <iframe width="100%" height="180" style="border-radius:11px;border:0" src="https://maps.google.com/maps?q=Springfield&t=&z=13&ie=UTF8&iwloc=&output=embed"></iframe>
    </div>`);

  // Theme/template selection logic for switching starter HTML
  document.querySelectorAll('.select-theme-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Save current page before switching
      pages[currentPageKey] = editor.getHtml();
      let themeId = btn.dataset.theme;
      let html = themeHtmlMap[themeId] || defaultHTML;
      editor.setComponents(html);
      pages[currentPageKey] = html;
    });
  });

  // Save the current page when form is submitted
  document.getElementById('save-html-form').addEventListener('submit', function(e){
    pages[currentPageKey] = editor.getHtml();
    document.getElementById('page_html').value = pages[currentPageKey];
  });

  // Initialize builder with Home page content
  loadPage('home');
</script>
</body>
</html>