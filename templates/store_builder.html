<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store Website Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(120deg, #151e28 0%, #203b4e 100%); color: #e9f2fb !important; font-family: 'Segoe UI', Arial, sans-serif; min-height: 100vh;}
    .builder-toolbar { background: #21253b; box-shadow: 0 4px 18px #002f5988; border-radius: 13px; max-width:1300px; margin:26px auto 10px auto; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; padding:0.6em 2em;}
    .builder-title { font-size: 1.7em; font-weight: bold; background: linear-gradient(93deg, #6afadc, #db8abf, #50cdc1, #5b8dfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;}
    .theme-toggle { background: #1a293c; color: #89c5ff; border-radius:5px; border:2px solid #2f81d8; padding:5px 17px; font-size:1em; cursor:pointer;}
    .gjs-editor-row { max-width: 1260px; margin:auto; min-height:400px;}
    #gjs { min-height: 68vh; border-radius: 13px; background: #f6fbfd; box-shadow: 0 8px 48px #03253621; border: 2.5px solid #4373b7; }
    .theme-gallery-wrap { background:#181b24; border-radius:15px; box-shadow:0 2px 14px #0a112084; max-width:1220px; margin:10px auto 3rem auto; padding:22px 18px;}
    .theme-gallery-title { color: #5bddff; font-size:1.3em; font-weight:700;}
    .theme-gallery-row { display: flex; gap:1.1em; flex-wrap:wrap; justify-content:center;}
    .theme-preview-card { width:200px; background:#fff; border-radius:10px; box-shadow:0 2px 14px #89caf029; margin-bottom:16px;}
    .theme-preview-thumb { width:100%; height:108px; object-fit:cover; border-top-left-radius:10px; border-top-right-radius:10px;}
    .theme-preview-title { font-weight:700; font-size:1.06em; color:#262e40; padding:0.51em 0 0 1.0em; text-align:left;}
    .theme-preview-desc { font-size:.93em; color:#4a5979; min-height:36px; padding:0 1em 0.9em 1em; text-align:left;}
    .theme-preview-btn { display:block; background:#2659cf;color:#fff; border-radius:5px; padding:7px 0; text-align:center; font-weight:600; margin:0 1em 1em 1em; border:none; cursor:pointer;}
    .theme-preview-btn:hover { background:#177b6d;}
  </style>
</head>
<body>
<div class="builder-toolbar">
  <span class="builder-title"><i class="bi bi-cpu me-1"></i> Store Website Builder</span>
  <button class="theme-toggle" id="themeToggle"><i class="bi bi-lightbulb"></i> Switch Color Scheme</button>
</div>
<div class="gjs-editor-row">
  <div id="gjs"></div>
</div>
<!-- THEME GALLERY BELOW BUILDER -->
<div class="theme-gallery-wrap mb-5">
  <div class="theme-gallery-title mb-3">⭐ Or pick a full-page starting template (click "Load"):</div>
  <div class="theme-gallery-row">
    {% for theme in themes %}
      <div class="theme-preview-card">
        <img class="theme-preview-thumb" src="{{ theme.thumbnail_url or 'https://via.placeholder.com/206x120.png?text=Theme' }}" alt="{{ theme.name }}">
        <div class="theme-preview-title">{{ theme.name }}</div>
        <div class="theme-preview-desc">{{ theme.starter_html[:110]|striptags }}...</div>
        <button class="theme-preview-btn" onclick="loadBuilderTheme('{{ theme.id }}')">Load</button>
      </div>
    {% endfor %}
  </div>
</div>
<form id="save-html-form" method="POST" action="">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="page_html" id="page_html">
  <button type="submit" class="btn btn-success mt-3 ms-1">Save Website</button>
  <a href="{{ url_for('store_admin') }}" class="btn btn-secondary mt-3 ms-2">Back to Store Admin</a>
</form>

<script src="https://unpkg.com/grapesjs"></script>
<script>
  // Toggle color scheme
  document.getElementById('themeToggle').addEventListener('click', function() {
    document.body.classList.toggle('dark-theme');
    this.classList.toggle('active');
  });

  // Theme selection logic
  const themeHtmlMap = {{ theme_html_map | safe }};
  function loadBuilderTheme(themeId) {
    editor.setComponents(themeHtmlMap[themeId] || '');
  }

  // All builder blocks
  const editor = grapesjs.init({
    container: '#gjs',
    fromElement: false,
    height: '580px',
    width: 'auto',
    storageManager: false,
    blockManager: {
      appendTo: null,
      blocks: [
        { id:'hero', label:'<i class="bi bi-star"></i> Hero', category:'Sections', content:`<section style="padding:50px 0;text-align:center;background:#eaf6fd;"><h2 class="mb-2">Welcome!</h2><p>Your main message here.</p></section>` },
        { id:'img', label:'<i class="bi bi-image"></i> Image', category:'Media', content:{type:'image',src:'https://via.placeholder.com/500x200.png?text=Add+Your+Image'} },
        { id:'row-lr', label:'<i class="bi bi-layout-sidebar"></i> Img left/Text right', category:'Layouts', content:`<div style="display:flex;gap:18px;align-items:center;max-width:900px;margin:38px auto;"><img src="https://via.placeholder.com/260x140.png?text=Image" style="width:38%;border-radius:11px;"><div><h4>Product or Service</h4><p>Describe it here.</p></div></div>` },
        { id:'row-rl', label:'<i class="bi bi-layout-sidebar-reverse"></i> Text left/Img right', category:'Layouts', content:`<div style="display:flex;gap:18px;align-items:center;max-width:900px;margin:38px auto;"><div><h4>Another Feature</h4><p>Explain with text here.</p></div><img src="https://via.placeholder.com/260x140.png?text=Image" style="width:38%;border-radius:11px;"></div>` },
        { id:'slider', label:'<i class="bi bi-sliders"></i> Image Slider', category:'Media', content:`<div class="swiper mySwiper" style="max-width:600px;margin:40px auto;"><div class="swiper-wrapper"><div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+1" style="width:100%;border-radius:10px;"></div><div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+2" style="width:100%;border-radius:10px;"></div><div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+3" style="width:100%;border-radius:10px;"></div></div><div class="swiper-pagination"></div></div><script>try{ new Swiper('.mySwiper', {pagination:{el:'.swiper-pagination',clickable:true},loop:true}); }catch(err) {}<\/script>` },
        { id:'paragraph', label:'<i class="bi bi-align-left"></i> Paragraph', category:'Content', content:`<div class="py-3" style="max-width:560px;margin:auto;"><p style="font-size:1.1em;">Write about your story, value, or any detail here.</p></div>` },
        { id:'products', label:'<i class="bi bi-collection"></i> Products', category:'Store', content:`<div class="mx-auto my-3" style="max-width:950px;"><h3 class="mb-3 text-center">Featured Products</h3><div style="display:flex;flex-wrap:wrap;gap:1.4rem;justify-content:center;"><div style="width:220px;" class="p-3 border rounded bg-light"><img src="https://via.placeholder.com/200x130.png?text=Product+1" style="width:100%;border-radius:7px;"><div class="fw-semibold mt-2">Product Name</div><div class="text-success mb-1">$19.95</div></div><div style="width:220px;" class="p-3 border rounded bg-light"><img src="https://via.placeholder.com/200x130.png?text=Product+2" style="width:100%;border-radius:7px;"><div class="fw-semibold mt-2">Product Name</div><div class="text-success mb-1">$24.99</div></div></div></div>` },
        { id:'testimonial', label:'<i class="bi bi-chat-quote"></i> Testimonial', category:'Content', content:`<blockquote style="max-width:560px;margin:2.5rem auto;padding:20px 26px;background:#f9f6eb;border-left:5px solid #ffd66b;border-radius:10px;"><div style="font-size:1.15em;font-style:italic;">“Amazing service! Quick, easy, and just what my family needed.”</div><hr><div style="color:#9a8965;font-weight:600;">– Happy Customer</div></blockquote>` },
        { id:'contact', label:'<i class="bi bi-envelope"></i> Contact', category:'Content', content:`<section style="padding:35px 0;text-align:center;"><div style="max-width:500px;margin:auto"><h4>Contact Us</h4><form><input type="text" placeholder="Your Name" class="form-control mb-2"><input type="email" placeholder="Your Email" class="form-control mb-2"><textarea class="form-control mb-2" placeholder="Message"></textarea><button class="btn btn-primary">Send Message</button></form></div></section>` },
        { id:'divider', label:'<i class="bi bi-dash-lg"></i> Divider', category:'Content', content:`<hr style="margin:40px 0;border:0;height:2px;background:linear-gradient(90deg,transparent,#9cf 60%,transparent 100%);">` },
        { id:'btn', label:'<i class="bi bi-square"></i> Button', category:'Content', content:`<a href="#" class="btn btn-primary">Click Me</a>` },
        { id:'map', label:'<i class="bi bi-geo-alt"></i> Map', category:'Content', content:`<div style="width:100%;max-width:430px;margin:18px auto;"><iframe width="100%" height="180" style="border-radius:11px;border:0" src="https://maps.google.com/maps?q=Springfield&t=&z=13&ie=UTF8&iwloc=&output=embed"></iframe></div>` }
      ]
    }
  });

  document.getElementById('save-html-form').addEventListener('submit', function(e){
    document.getElementById('page_html').value = editor.getHtml();
  });

</script>
</body>
</html>