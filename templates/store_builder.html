<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store Website Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Swiper for image slider block (optional, safe) -->
  <link rel="stylesheet" href="https://unpkg.com/swiper@11.1.4/swiper-bundle.min.css">
  <style>
    body { background: linear-gradient(120deg, #151e28 0%, #203b4e 100%); color: #e9f2fb; min-height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; }
    .builder-toolbar { background: linear-gradient(90deg, #111d2e 0%, #1d3252 99%); box-shadow: 0 4px 22px #00111980; border-radius: 13px; max-width: 1200px; margin: 26px auto 14px auto; display: flex; align-items:center; justify-content: space-between; flex-wrap:wrap; padding: 0.55em 2.1em 0.45em 1.5em;}
    .builder-title { font-size: 1.7em; font-weight: bold; letter-spacing: 1px; background: linear-gradient(93deg, #6afadc, #db8abf, #50cdc1, #5b8dfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;}
    .theme-toggle { background: #1a293c; color: #89c5ff; border-radius: 6px; border: 2px solid #2f81d8; cursor: pointer; padding: 6px 19px; margin-left: 1em; font-size: 1em;}
    .theme-toggle.active { background: #223d60; color: #ffe25a; border-color: #db8abf;}
    .page-bar { display: flex; gap:1.25em; align-items: center; margin-top:.12em;}
    .page-btn { background: #262c48; color: #8ad6f6; border: 1.5px solid #498bf0; border-radius:7px; font-weight:500; padding:4.5px 14px; font-size:1.08em; cursor:pointer;}
    .page-btn.active, .page-btn:focus { background:#3657a8; color:#ffe25a; border-color: #db8abf;}
    .gjs-editor-row { max-width: 1260px; margin:auto;}
    @media (max-width:1000px) { .gjs-editor-row { flex-direction:column; gap:13px; } .gjs-pn-panels { width: 100% !important; } }
    @media (max-width:600px) { .builder-toolbar { flex-direction:column; gap:5px; padding:1em 0.5em; } }
    .theme-gallery-wrap { background:#181b24; border-radius:15px; box-shadow:0 3px 18px #0a112084; max-width:1220px; margin:0 auto 3rem auto; padding: 26px 24px; }
    .theme-gallery-title { color: #5bddff; font-size:1.45em; font-weight:700; letter-spacing:.015em }
    .theme-gallery-row { display: flex; gap:1.7em; flex-wrap:wrap; justify-content:center;}
    .theme-preview-card { width:210px; background:#fff; border-radius:14px; box-shadow:0 2px 14px #89caf07a; margin-bottom:24px;}
    .theme-preview-thumb { width:100%; height:120px; object-fit:cover; border-top-left-radius:14px; border-top-right-radius:14px;}
    .theme-preview-title { font-weight:700; font-size:1.12em; color:#262e40; padding:0.67em 0 0 1.0em; text-align:left;}
    .theme-preview-desc { font-size:.97em; color:#4a5979; min-height:36px; padding:0 1em 0.9em 1em; text-align:left;}
    .theme-preview-btn { display:block; background:#2659cf;color:#fff; border-radius:6px; padding:7px 0; text-align:center; font-weight:600; margin:0 1em 1.1em 1em; border:none; cursor:pointer; transition:.16s;}
    .theme-preview-btn:hover { background:#177b6d;}
  </style>
</head>
<body>
<div class="builder-toolbar">
  <span class="builder-title"><i class="bi bi-cpu me-1"></i> Store Website Builder</span>
  <div class="page-bar">
    <button class="page-btn active" data-page="home">Home Page</button>
    <button class="page-btn" data-page="page2">Page 2</button>
    <button class="page-btn" data-page="page3">Page 3</button>
  </div>
  <button class="theme-toggle" id="themeToggle"><i class="bi bi-lightbulb"></i> Switch Color Scheme</button>
</div>
<!-- GrapesJS Builder and Sidebar: native block manager for draggable blocks! -->
<div class="gjs-editor-row">
  <div id="gjs"></div>
</div>
<!-- THEME GALLERY BELOW BUILDER -->
<div class="theme-gallery-wrap mb-5">
  <div class="theme-gallery-title mb-3">⭐ Or pick a full-page starting template (click "Load"):</div>
  <div class="theme-gallery-row">
    {% for theme in themes %}
      <div class="theme-preview-card">
        <img class="theme-preview-thumb" src="{{ theme.thumbnail_url or 'https://via.placeholder.com/206x120.png?text=Theme' }}" alt="{{ theme.name }}">
        <div class="theme-preview-title">{{ theme.name }}</div>
        <div class="theme-preview-desc">{{ theme.starter_html[:110]|striptags }}...</div>
        <button class="theme-preview-btn" onclick="loadBuilderTheme('{{ theme.id }}')">Load</button>
      </div>
    {% endfor %}
  </div>
</div>
<form id="save-html-form" method="POST" action="">
  <input type="hidden" name="page_html" id="page_html">
  <button type="submit" class="btn btn-success mt-3 ms-1">Save Website</button>
  <a href="{{ url_for('store_admin') }}" class="btn btn-secondary mt-3 ms-2">Back to Store Admin</a>
</form>

<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/swiper@11.1.4/swiper-bundle.min.js"></script>
<script>
  // Color/theme toggle
  const toggleBtn = document.getElementById('themeToggle');
  toggleBtn.addEventListener('click', function() {
    document.body.classList.toggle('dark-theme');
    toggleBtn.classList.toggle('active');
  });

  // Multi-page support
  const pages = { home: `{{ saved_html | safe }}`, page2: '', page3: '' };
  let currentPageKey = 'home';
  function loadPage(pageKey) {
    currentPageKey = pageKey;
    editor.setComponents(pages[pageKey] || '');
    document.querySelectorAll('.page-btn').forEach(btn =>
      btn.classList.toggle('active', btn.dataset.page === pageKey)
    );
  }
  document.querySelectorAll('.page-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      pages[currentPageKey] = editor.getHtml();
      loadPage(btn.dataset.page);
    });
  });

  // Theme gallery load logic
  const themeHtmlMap = {{ theme_html_map | safe }};
  function loadBuilderTheme(themeId) {
    pages[currentPageKey] = themeHtmlMap[themeId] || '';
    editor.setComponents(pages[currentPageKey]);
  }

  // Build GrapesJS and block manager with native drag-and-drop
  let defaultHTML = `<section style="padding:40px 0;text-align:center;background:#f8faff;"><h2>Welcome to Your Store</h2><p>Drag content to start building your front page.</p></section>`;

  // True drag-and-drop! GrapesJS's own native panel.
  const editor = grapesjs.init({
    container: '#gjs',
    fromElement: false,
    height: '560px',
    width: 'auto',
    storageManager: false,
    panels: { defaults: [] },
    blockManager: {
      appendTo: '.gjs-editor-row',
      blocks: [
        {
          id: 'hero',
          label: '<i class="bi bi-star"></i> Hero',
          category: 'Sections',
          content: `<section style="padding:50px 0;text-align:center;background:#eaf6fd;">
            <h2 class="mb-2" style="font-size:2.05em;font-weight:800;">Welcome to Our Store!</h2>
            <p style="font-size:1.19em;">Drag elements to build your business page.</p>
            <a href="#products" class="btn btn-primary btn-lg mt-2">Shop Now</a>
            </section>`
        },
        {
          id: 'hero-bg',
          label: '<i class="bi bi-image"></i> Hero w/ BG',
          category: 'Sections',
          content: `<section style="padding:54px 0;text-align:center;background:url('https://images.unsplash.com/photo-1465101178521-c5544921c3da?auto=format&fit=crop&w=1200&q=80') center/cover no-repeat;">
            <div style="background:rgba(24,32,72,0.33);padding:26px 8px; border-radius:22px;display:inline-block;">
              <h2 class="mb-2" style="font-weight:700;font-size:2em;color:#fff;">Big Message Here!</h2>
              <p style="color:#ffe25a;">Bold call to action goes here!</p>
            </div></section>`
        },
        {
          id: 'row-lr',
          label: '<i class="bi bi-layout-sidebar"></i> Img left/Text right',
          category: 'Layouts',
          content: `<div style="display:flex;gap:26px;align-items:center;max-width:900px;margin:42px auto;">
            <img src="https://via.placeholder.com/280x180.png?text=Image" style="width:42%;border-radius:16px;">
            <div>
              <h3>Title left, image right</h3>
              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque efficitur.</p>
            </div></div>`
        },
        {
          id: 'row-rl',
          label: '<i class="bi bi-layout-sidebar-reverse"></i> Text left/Img right',
          category: 'Layouts',
          content: `<div style="display:flex;gap:26px;align-items:center;max-width:900px;margin:42px auto;">
            <div>
              <h3>Image left, text right</h3>
              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque efficitur.</p>
            </div>
            <img src="https://via.placeholder.com/280x180.png?text=Image" style="width:42%;border-radius:16px;">
            </div>`
        },
        {
          id: 'slider',
          label: '<i class="bi bi-sliders"></i> Image Slider',
          category: 'Media',
          content: `<div class="swiper mySwiper" style="max-width:660px;margin:40px auto;">
            <div class="swiper-wrapper">
              <div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+1" style="width:100%;border-radius:10px;"></div>
              <div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+2" style="width:100%;border-radius:10px;"></div>
              <div class="swiper-slide"><img src="https://via.placeholder.com/600x200.png?text=Slide+3" style="width:100%;border-radius:10px;"></div>
            </div>
            <div class="swiper-pagination"></div>
          </div>
          <script>
          try{ new Swiper('.mySwiper', {pagination:{el:'.swiper-pagination',clickable:true},loop:true}); }catch(err){}
          </script>`
        },
        {
          id: 'img',
          label: '<i class="bi bi-image"></i> Image',
          category: 'Media',
          content: { type: 'image', src: 'https://via.placeholder.com/400x200.png?text=Your+Image' }
        },
        {
          id: 'paragraph',
          label: '<i class="bi bi-align-left"></i> Paragraph',
          category: 'Content',
          content: `<div class="py-3" style="max-width:560px;margin:auto;"><p style="font-size:1.1em;">Describe your business, add info or details here.</p></div>`
        },
        {
          id: 'products',
          label: '<i class="bi bi-collection"></i> Product Grid',
          category: 'Store',
          content: `<div class="mx-auto my-3" style="max-width:950px;">
          <h3 class="mb-3 text-center">Featured Products</h3>
          <div style="display:flex;flex-wrap:wrap;gap:1.4rem;justify-content:center;">
            <div style="width:220px;" class="p-3 border rounded bg-light">
              <img src="https://via.placeholder.com/200x130.png?text=Product+1" style="width:100%;border-radius:7px;">
              <div class="fw-semibold mt-2">Product Name</div>
              <div class="text-success mb-1">$19.95</div>
            </div>
            <div style="width:220px;" class="p-3 border rounded bg-light">
              <img src="https://via.placeholder.com/200x130.png?text=Product+2" style="width:100%;border-radius:7px;">
              <div class="fw-semibold mt-2">Product Name</div>
              <div class="text-success mb-1">$24.99</div>
            </div>
          </div>
          </div>`
        },
        {
          id: 'testimonial',
          label: '<i class="bi bi-chat-quote"></i> Testimonial',
          category: 'Content',
          content: `<blockquote style="max-width:560px;margin:2.5rem auto;padding:20px 26px;background:#f9f6eb;border-left:5px solid #ffd66b;border-radius:10px;">
          <div style="font-size:1.15em;font-style:italic;">“Amazing service! Quick, easy, and just what my family needed.”</div>
          <hr>
          <div style="color:#9a8965;font-weight:600;">– Happy Customer</div></blockquote>`
        },
        {
          id: 'contact',
          label: '<i class="bi bi-envelope"></i> Contact Form',
          category: 'Content',
          content: `<section style="padding:35px 0;text-align:center;">
          <div style="max-width:500px;margin:auto">
            <h4>Contact Us</h4>
            <form><input type="text" placeholder="Your Name" class="form-control mb-2">
            <input type="email" placeholder="Your Email" class="form-control mb-2">
            <textarea class="form-control mb-2" placeholder="Message"></textarea>
            <button class="btn btn-primary">Send Message</button></form>
          </div></section>`
        },
        {
          id: 'header',
          label: '<i class="bi bi-window"></i> Header',
          category: 'Navigation',
          content: `<header class="mb-4" style="background:#222333;color:white;padding:16px 7px;border-radius:8px;text-align:center;">
    <h2 style="font-weight:900;font-size:2em;">My Store</h2>
    <nav><a href="#" class="mx-2" style="color:#8ef0fd;">Home</a><a href="#" class="mx-2" style="color:#8ef0fd;">Shop</a><a href="#" class="mx-2" style="color:#8ef0fd;">Contact</a></nav>
  </header>`
        },
        {
          id: 'footer',
          label: '<i class="bi bi-strava"></i> Footer',
          category: 'Navigation',
          content: `<footer style="background:#1a2239;color:#89c6ec;padding:22px 12px;margin-top:24px;">
    <div style="text-align:center;">&copy; 2026 My Store. All rights reserved.</div></footer>`
        },
        {
          id: 'divider',
          label: '<i class="bi bi-dash-lg"></i> Divider',
          category: 'Content',
          content: `<hr style="margin:40px 0;border:0;height:2px;background:linear-gradient(90deg,transparent,#9cf 60%,transparent 100%);">`
        },
        {
          id: 'button',
          label: '<i class="bi bi-square"></i> Button',
          category: 'Content',
          content: `<a href="#" class="btn btn-primary">Click Me</a>`
        },
        {
          id: 'map',
          label: '<i class="bi bi-geo-alt"></i> Map',
          category: 'Content',
          content: `<div style="width:100%;max-width:430px;margin:18px auto;">
    <iframe width="100%" height="180" style="border-radius:11px;border:0" src="https://maps.google.com/maps?q=Springfield&t=&z=13&ie=UTF8&iwloc=&output=embed"></iframe>
    </div>`
        },
        {
          id: 'fadein',
          label: '<i class="bi bi-asterisk"></i> Fade-in Block',
          category: 'Animations',
          content: `<div class="animate-fadein" style="padding:20px 0;text-align:center;">
    <h4 style="font-weight:800;">Animated Block</h4>
    <p>Add cool fade-in effects to any content!</p></div>`
        }
      ]
    }
  });

  // Theme gallery loads starter HTML into builder for the current page
  window.loadBuilderTheme = function(themeId) {
    pages[currentPageKey] = themeHtmlMap[themeId] || '';
    editor.setComponents(pages[currentPageKey]);
  };

  document.getElementById('save-html-form').addEventListener('submit', function(e){
    pages[currentPageKey] = editor.getHtml();
    document.getElementById('page_html').value = pages[currentPageKey];
  });

  // Multi-page: load Home on page load
  loadPage('home');
</script>
</body>
</html>