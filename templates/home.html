<!DOCTYPE html>
<html>
<head>
  <title>PerkMiner Homepage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <style>
    :root { --pm-primary: #2a5859; --pm-accent: #ffd66b; --pm-bg: #fff; --pm-text: #222; --pm-hover: #e6f6f5;}
    body { background: var(--pm-bg); color: var(--pm-text);}
    .navbar-brand img.nav-logo { height: 90px; width: auto; max-width: 140px;}
    .hero-logo { height: 90px; max-width: 280px; width: auto; display: block; margin: 0 auto 18px auto; object-fit: contain;}
    .hero-section { min-height: 45vh; background: url('https://res.cloudinary.com/dmrntlcfd/image/upload/v1771643789/cash-back_x9kj5f.jpg?auto=format&fit=crop&w=1200&q=60') center/cover no-repeat; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 0;}
    .hero-section .overlay { position: absolute; inset: 0; background: rgba(42,88,89,.53); z-index: 1; }
    .hero-content { position: relative; z-index: 2; width: 100%; max-width: 620px; margin: 0 auto; color: #fff; padding-top: 1.5rem; padding-bottom: 1rem; text-align: center;}
    .dashboard-btn-hero { position: absolute; top: 18px; right: 32px; z-index: 5;}
    @media (max-width: 700px) { .dashboard-btn-hero { top: 8px; right: 12px; } }
    .dashboard-btn-hero .btn { font-size: 0.93rem; padding: 0.28rem 0.85rem; border-radius: 15px; box-shadow: 0 2px 10px #e6f4ee; }
    .totals-section { margin-top: 0.5rem; margin-bottom: 0.8rem;}
    .totals-mini { background: #fff; border: 1px solid #e7ebed; border-radius: 10px; box-shadow: 0 1px 5px #e6f4ee; padding: .35rem 0.7rem .25rem 0.7rem; min-width: 106px; min-height: 42px; display: inline-block; margin: 0 3px 6px 3px;}
    .totals-label-mini { font-size: 0.61em; color: #305A5B; font-weight: 600; line-height: 1.07; margin-bottom: -3px;}
    .totals-value-mini { font-size: 0.95em; font-weight: 700;}
    .totals-value-mini.text-warning { color: #d8a608 !important; }
    .totals-value-mini.text-info { color: #1097bb !important; }
    .search-form .input-group { border-radius: 18px; box-shadow: 0 2px 10px #f2f5f5; background: #fff; overflow: hidden;}
    .search-form .form-control, .search-form .btn { border-radius: 18px !important; font-size: 1.1em;}
    .categories-scroll-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-left: -2vw; margin-right: -2vw; padding-bottom: 10px; position: relative;}
    .categories-row { display: flex; flex-wrap: nowrap; gap: 12px; padding-left: 2vw; padding-right: 18vw; min-width: 280px;}
    .category-card { border-radius: 12px; overflow: hidden; border: none; box-shadow: 0 3px 10px #d1e7e0; cursor: pointer; background: #fff; min-width: 40vw; max-width: 120px; min-height: 110px; padding: 0 0 4px 0; opacity: 0.98; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;}
    @media (max-width: 600px) { .category-card { min-width: 49vw; max-width: 49vw; } }
    @media (min-width: 992px){ .categories-scroll-wrap, .categories-row { display: block !important; overflow-x: unset !important; gap: 0 !important; } .categories-row { display: grid !important; grid-template-columns: repeat(6,1fr); padding: 0; min-width: 0;} .category-card { min-width: 0; max-width: none; margin-right: 0;} .categories-swiper-label { display: none !important; }}
    .categories-swiper-label { display: none;}
    @media (max-width: 991px) { .categories-swiper-label { display: block; color: #3c5373;font-weight:500;font-size:0.99em;letter-spacing:0.01em;margin-bottom:7px;} }
    .category-image { width: 100%; height: 67px; max-height:40vw; object-fit: cover; display:block; border-top-left-radius: 12px; border-top-right-radius: 12px; margin-bottom: 5px; background: #fff;}
    .category-label { font-size: 0.98em; color: var(--pm-primary); font-weight: 500; text-align: center; margin-bottom: 8px; margin-top: 2px; white-space: normal;}
    .categories-scroll-fade { display: none; }
    .business-listing-modern {
      border: none;
      overflow: hidden;
      border-radius: 14px;
      background: #fff;
      box-shadow: 0 4px 18px #e5eceb;
      transition: box-shadow 0.18s, transform 0.16s;
      min-height: 360px;
      max-width: 380px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }
    .biz-feature-img-wrap {
      width: 100%;
      height: 180px;
      overflow: hidden;
      border-radius: 14px 14px 0 0;
      background: #f7f7f7;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .biz-feature-img,
    .small-listing-modern-img {
      width: 100%;
      height: 100%;
      object-fit: cover;                /* or contain if you prefer no cropping */
      display: block;
      margin: 0 auto;                   /* centers if not full size */
    }
    .small-listing-modern-img {
      width: 180px;
      height: 180px;
      object-fit: cover;
    }
    .biz-services {
      white-space: normal;
      overflow-wrap: break-word;
      word-break: break-word;
      max-width: 100%;
      margin: 0 auto;
      display: block;
      font-size: .94em;
      color: #345;
      font-weight: 500;
      opacity: .93;
    }

    .mb-1.small { font-size: .96em; }
    @media (max-width:600px) {
      .business-listing-modern { max-width: 97vw; }
      .biz-services { max-width: 74vw; font-size:.98em;}
      .biz-feature-img-wrap { height: 160px; }
      .biz-feature-img,
      .small-listing-modern-img { 
        width: 160px; 
        height: 160px; 
      }
    }
    footer { background: #f8fafb; color: #999; padding: 1.5rem 0; margin-top: 2.3rem; text-align: center; font-size: 1em; border-top: 1px solid #e1e7ea; }

    /* ────────────────────────────────────────────────
       Infinite scrolling marquee (added - pure CSS)
    ──────────────────────────────────────────────── */
    .marquee-container {
      --speed: 15s;           /* adjust: lower = faster */
      --gap: 4rem;            /* spacing between repeated sections */
      width: 100%;
      overflow: hidden;
      background: var(--pm-primary);
      color: white;
      padding: 0.9rem 0;
      margin: 0;
      border-top: 2px solid var(--pm-accent);
      border-bottom: 2px solid var(--pm-accent);
      box-shadow: 0 2px 12px rgba(42,88,89,0.25);
    }

    .marquee {
      display: flex;
      white-space: nowrap;
      animation: scroll var(--speed) linear infinite;
    }

    .marquee:hover {
      animation-play-state: paused;
      cursor: default;
    }

    .marquee-content {
      display: inline-flex;
      align-items: center;
      gap: var(--gap);
      font-size: 1.35rem;
      font-weight: 600;
      padding: 0 2rem;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .marquee-content span.highlight {
      color: var(--pm-accent);
      font-weight: 700;
    }

    @keyframes scroll {
      from { transform: translateX(0); }
      to   { transform: translateX(calc(-100% - var(--gap))); }
    }

    @media (max-width: 576px) {
      .marquee-content { font-size: 1.1rem; }
      .marquee-container { padding: 0.7rem 0; }
    }
  </style>
</head>
<body>
  <section class="hero-section">
    <div class="overlay"></div>
    {% if current_user.is_authenticated %}
      <div class="dashboard-btn-hero">
        {% if current_user.business_email %}
          <a href="{{ url_for('business_dashboard') }}" class="btn btn-warning shadow">Return to Dashboard</a>
        {% else %}
          <a href="{{ url_for('dashboard') }}" class="btn btn-warning shadow">Return to Dashboard</a>
        {% endif %}
      </div>
    {% elif session.get('business_id') %}
      <div class="dashboard-btn-hero">
        <a href="{{ url_for('business_dashboard') }}" class="btn btn-warning shadow">Return to Dashboard</a>
      </div>
    {% endif %}
    <div class="container hero-content">
      <img src="https://res.cloudinary.com/dmrntlcfd/image/upload/v1771632656/New_Perk_Miner_Logo_xt8y0e.jpg" alt="Perk Miner" class="hero-logo">
      <h1 class="mb-2">Welcome to PerkMiner</h1>
      <form class="search-form mb-3" method="get" action="/search">
        <div class="input-group mb-2">
          <input type="text" class="form-control" name="q" placeholder="Search for products, services, or businesses..." aria-label="Search">
          <select class="form-select" name="distance" style="max-width:110px;">
            <option value="">Closest</option>
            <option value="5">5 mi</option>
            <option value="10">10 mi</option>
            <option value="25">25 mi</option>
            <option value="all">All</option>
          </select>
          <button class="btn btn-primary" type="submit">Search</button>
        </div>
        <input type="hidden" name="lat" id="search-lat">
        <input type="hidden" name="lng" id="search-lng">
      </form>
      <div class="container-fluid d-flex flex-wrap justify-content-center totals-section px-0">
        <!-- your totals-mini cards here (unchanged) -->
        <div class="totals-mini mx-1">
          <div class="totals-label-mini">Member Cash Back<br>and Commissions Paid</div>
          <div class="totals-value-mini text-success">${{ "{:,.2f}".format(total_member_paid|default(0, true)) }}</div>
        </div>
        <div class="totals-mini mx-1">
          <div class="totals-label-mini">Business Cash Back<br>and Commissions Paid</div>
          <div class="totals-value-mini text-primary">${{ "{:,.2f}".format(total_biz_paid|default(0, true)) }}</div>
        </div>
        <div class="totals-mini mx-1">
          <div class="totals-label-mini">Gross Sales Generated<br>By Our Advertisers</div>
          <div class="totals-value-mini text-dark">${{ "{:,.2f}".format(total_gross_sales|default(0, true)) }}</div>
        </div>
        <div class="totals-mini mx-1">
          <div class="totals-label-mini">Advertising Fees<br>Paid By Advertisers</div>
          <div class="totals-value-mini text-info">${{ "{:,.2f}".format(total_ad_fees|default(0, true)) }}</div>
        </div>
        <div class="totals-mini mx-1">
          <div class="totals-label-mini">Percent of Ad Revenues<br>Paid To Members & Businesses</div>
          <div class="totals-value-mini text-warning">
            {{ percent_fees_paid|default(0, true)|round(1) }}%
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Scrolling marquee added here – right above the nav bar -->
  <div class="marquee-container">
    <div class="marquee">
      <!-- Duplicate for seamless loop -->
      <div class="marquee-content">
        *****          <span class="highlight">Earn Cash Back & Commissions (Paid By Perk Miner)</span>Free To Join
        <span class="highlight">Cash Back on Everyday Purchases</span>No Sale/Close = No Fee For Advertisers          *****
        &nbsp;&nbsp;&nbsp;
      </div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-0">
    <div class="container">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/login">Login</a>
          <a class="nav-link" href="/register">Register</a>
          <a class="nav-link" href="/business">Advertise with Us</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="container my-5">
    <h2 class="mb-2 mt-3 mt-md-0 text-center">Browse by Popular Categories</h2>
    <div class="d-md-none categories-swiper-label text-center mb-2">
      <span>↔ Swipe categories for more</span>
    </div>
    <div class="categories-scroll-wrap position-relative mb-4">
      <div class="categories-row">
        <!-- ...category cards unchanged... -->
        <a href="/category/Handyman-Contractor" class="text-decoration-none">
          <div class="category-card text-center">
            <img src="https://res.cloudinary.com/dmrntlcfd/image/upload/v1771634200/Handyman_ig9cin.jpg?auto=format&fit=crop&w=300&q=40" alt="Handyman-Contractor" class="category-image">
            <div class="category-label">Handyman</div>
          </div>
        </a>
        <a href="/category/Auto%20Parts%20&%20Service" class="text-decoration-none">
          <div class="category-card text-center">
            <img src="https://res.cloudinary.com/dmrntlcfd/image/upload/v1771634200/Auto-Service_iamnu3.jpg?auto=format&fit=crop&w=300&q=40" alt="Auto Parts & Service" class="category-image">
            <div class="category-label">Auto Service</div>
          </div>
        </a>
        <a href="/category/Home%20and%20Garden" class="text-decoration-none">
          <div class="category-card text-center">
            <img src="https://res.cloudinary.com/dmrntlcfd/image/upload/v1771634200/Home-Garden_lhssqa.jpg?auto=format&fit=crop&w=300&q=40" alt="Home and Garden" class="category-image">
            <div class="category-label">Home & Garden</div>
          </div>
        </a>
        <a href="/category/Retail%20Outlet" class="text-decoration-none">
          <div class="category-card text-center">
            <img src="https://res.cloudinary.com/dmrntlcfd/image/upload/v1771634200/Retail_h510gq.jpg?auto=format&fit=crop&w=300&q=40" alt="Retail Outlet" class="category-image">
            <div class="category-label">Retail Outlet</div>
          </div>
        </a>
        <a href="/category/Professional%20Services" class="text-decoration-none">
          <div class="category-card text-center">
            <img src="https://res.cloudinary.com/dmrntlcfd/image/upload/v1771634200/Professional-Services_s9cyxd.jpg?auto=format&fit=crop&w=300&q=40" alt="Professional Services" class="category-image">
            <div class="category-label">Professional</div>
          </div>
        </a>
        <a href="/category/Restaurant" class="text-decoration-none">
          <div class="category-card text-center">
            <img src="https://res.cloudinary.com/dmrntlcfd/image/upload/v1771634200/Restaurant_d1ioep.jpg?auto=format&fit=crop&w=300&q=40" alt="Restaurant" class="category-image">
            <div class="category-label">Restaurant</div>
          </div>
        </a>
      </div>
    </div>

    <!-- DYNAMIC FEATURED BUSINESSES -->
    <h3 class="mt-5 mb-3 text-start">Featured Businesses Near You</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-5 g-4">
      {% for biz in featured_listings %}
      <div class="col">
            <a href="{{ url_for('view_listing', biz_id=biz.id, distance_mi=biz.distance_mi, from_featured=1) }}" style="text-decoration:none;">
              <div class="small-listing-modern">
                {% if biz.profile_photo %}
                  <img src="{{ biz.profile_photo }}" class="small-listing-modern-img" alt="{{ biz.business_name }} logo">
                {% else %}
                  <div class="small-listing-modern-img d-flex align-items-center justify-content-center bg-light border">
                    <i class="bi bi-shop" style="font-size:1.6em; color:#2a5859;"></i>
                  </div>
                {% endif %}

            <div class="card-body text-center px-3">
              <h5 class="card-title mb-2">{{ biz.business_name }}</h5>
              <div class="mb-1 small" style="font-weight:500;">
                <span class="badge bg-success">{{ biz.category }}</span>
              </div>
              {% if biz.distance_mi is defined and biz.distance_mi is not none %}
                <span class="small-listing-mile-badge">
                  <i class="bi bi-geo-alt-fill"></i>
                  {{ biz.distance_mi|round(2) }} mi away
                </span>
              {% endif %}

              <div class="mb-1">
                <strong>Address:</strong> {{ biz.address or "N/A" }}
              </div>
              <div class="mb-1 biz-services" title="{{ [biz.service_1, biz.service_2, biz.service_3, biz.service_4, biz.service_5, biz.service_6, biz.service_7, biz.service_8, biz.service_9, biz.service_10]|select|reject('equalto','')|join(', ') }}">
                <strong>Services:</strong>
                {% set services = [biz.service_1, biz.service_2, biz.service_3, biz.service_4, biz.service_5, biz.service_6, biz.service_7, biz.service_8, biz.service_9, biz.service_10] %}
                {{ services|select|reject('equalto','')|join(', ') if services|select|reject('equalto','')|list else 'N/A' }}
              </div>
            </div>
          </div>
        </a>
      </div>
      {% endfor %}
      {% if featured_listings|length == 0 %}
      <div class="col-12">
        <div class="alert alert-warning text-center mt-3">
          No featured businesses at this time.
        </div>
      </div>
      {% endif %}
    </div>
    <div class="text-center mt-4">
      <p>Explore top businesses, find your next deal, or <a href="/business" style="color:var(--pm-primary);font-weight:500;">get listed today</a>.</p>
    </div>
  </main>
  <footer>
    <div>
      <div class="mb-2">
        <a href="/" style="color:var(--pm-primary);font-weight:600;text-decoration:none;">
          <img src="https://res.cloudinary.com/dmrntlcfd/image/upload/v1771632656/New_Perk_Miner_Logo_xt8y0e.jpg" alt="Perk Miner" class="hero-logo" style="height:54px;">
        </a> &copy; 2026
      </div>
      <div>
        <small>Need help? <a href="mailto:support@perkminer.com" style="color:var(--pm-primary);">Contact Support</a></small>
      </div>
      <div class="mt-1">
        <a href="#" style="color:#3dbbee; margin:0 6px;text-decoration:none;">Privacy</a>
        <a href="#" style="color:#3dbbee; margin:0 6px;text-decoration:none;">Terms</a>
      </div>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            document.getElementById('search-lat').value = position.coords.latitude;
            document.getElementById('search-lng').value = position.coords.longitude;
          }
        );
      }
    });
  </script>
<script>
window.addEventListener('DOMContentLoaded', function() {
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;
        var url = new URL(window.location.href);
        // Only reload if not already set
        var hasLatLng = url.searchParams.has('lat') && url.searchParams.has('lng');
        if (!hasLatLng) {
          url.searchParams.set('lat', lat);
          url.searchParams.set('lng', lng);
          window.location.replace(url);
        } else {
          document.getElementById('search-lat').value = lat;
          document.getElementById('search-lng').value = lng;
        }
      }
    );
  }
});
</script>
</body>
</html>